<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sites</title>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/PushNotification.js"></script>
    <script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <link href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />
    <script type="text/javascript">
        //***************************************
        $(document).on("pagecreate", "#map-page", function () {
            //*********************************
            var longitude = getUrlVars()["Longitude"];
            var latitude = getUrlVars()["Latitude"];
            var Site = getUrlVars()["Site"];
            //*********************************
            var defaultLatLng = new google.maps.LatLng(latitude, longitude);  // Default to Hollywood, CA when no geolocation support
            //*********************************
            if (navigator.geolocation) {
                function success(pos) {
                    // Location found, show map with these coordinates
                    drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                    //drawMap(new google.maps.LatLng(latitude, longitude));
                }
                function fail(error) {
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            alert("User denied the request for Geolocation.");
                            //navigator.notification.alert("User denied the request for Geolocation.", function () { }, "BCP Error");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert("Location information is unavailable.");
                            //navigator.notification.alert("Location information is unavailable.", function () { }, "BCP Error");
                            break;
                        case error.TIMEOUT:
                            alert("The request to get user location timed out.");
                            //navigator.notification.alert("The request to get user location timed out.", function () { }, "BCP Error");
                            break;
                        case error.UNKNOWN_ERROR:
                            alert("An unknown error occurred.");
                            //navigator.notification.alert("An unknown error occurred.", function () { }, "BCP Error");
                            break;
                    }
                    drawMap(defaultLatLng);
                }
                navigator.geolocation.getCurrentPosition(success, fail, { maximumAge: 500000, enableHighAccuracy: true, timeout: 6000 });
            } else {
                drawMap(defaultLatLng);  // No geolocation support, show default map
            }
            function drawMap(latlng) {
                var myOptions = {
                    zoom: 25,
                    center: latlng,
                    mapTypeId: google.maps.MapTypeId.SATELLITE,
                    backgroundColor: '#ffffff',
                    noClear: true,
                    disableDefaultUI: false,
                    keyboardShortcuts: true,
                    disableDoubleClickZoom: false,
                    draggable: true,
                    scrollwheel: true,
                    draggableCursor: 'pointer',
                    draggingCursor: 'crosshair',
                    mapTypeControl: true,
                    panControl: true,
                    panControlOptions: {
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },
                    navigationControl: true,
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    navigationControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP,
                        style: google.maps.NavigationControlStyle.ANDROID
                    },
                    scaleControl: true,
                    scaleControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP,
                        style: google.maps.ScaleControlStyle.DEFAULT
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        //style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.RIGHT_TOP
                    }
                };

                var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

                // Add an overlay to the map of current lat/lng 
                var marker = new google.maps.Marker({
                    position: latlng,
                    map: map,
                    animation: google.maps.Animation.DROP,
                    title: 'Current Location',
                    cursor: 'pointer',
                    draggable: false,
                    icon: 'images/bluecircle.png'
                });

                var latlngActual = new google.maps.LatLng(getUrlVars()["Latitude"], getUrlVars()["Longitude"]);
                var marketActual = new google.maps.Marker({
                    position: latlngActual,
                    map: map,
                    animation: google.maps.Animation.DROP,
                    title: 'Insight Risk Technologies, LLC',
                    cursor: 'pointer',
                    draggable: true
                })

                var Site = getUrlVars()["Site"];
                var contentString = '<div id="content">' + unescape(Site) + '</div>';
                var infowindow = new google.maps.InfoWindow({
                    content: contentString
                });
                infowindow.open(map, marketActual);
                google.maps.event.addListener(marketActual, 'click', function () {
                    infowindow.open(map, marketActual);
                    var pos = marketActual.getPosition();
                    var lat = pos.lat();
                    var lng = pos.lng();
                    $("#hdnLatitudeCOOP").val(lat);
                    $("#hdnLongitudeCOOP").val(lng);
                });

                google.maps.event.addListener(marketActual, 'drag', function () {
                    marketActual.setTitle(unescape(Site));
                    var pos = marketActual.getPosition();
                    var lat = pos.lat();
                    var lng = pos.lng();
                    $("#hdnLatitudeCOOP").val(lat);
                    $("#hdnLongitudeCOOP").val(lng);
                });

            }
            //*********************************
        });
        //***************************************
        populateDropdown = function (data) {
            var IdActivityLoss, ActivityLoss;
            IdActivityLoss = this.IdActivityLoss;
            ActivityLoss = this.ActivityLoss;
            $("#ddlCriticalFunction")
                .append($("<option></option>")
                .val(IdActivityLoss)
                .html(ActivityLoss)
                .attr("title", ActivityLoss));
        };
        //***************************************
        SendMessageAPNSMobile = function (IdCompany, IdSite, Message, xType, Code) {
            //***************************************
            var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
            var urlk1 = wcfServiceUrl + "SendMsgGCM?IdCompany=" + IdCompany + '&IdSite=' + IdSite + '&Message=' + Message + '&xType=' + xType + '&Code=' + Code;
            //***************************************
            $.ajax({
                cache: true,
                async: true,
                url: urlk1,
                crossDomain: true,
                data: "{ IdCompany: " + IdCompany + ", IdSite: " + IdSite + ", Message: " + Message + ", xType: " + xType + ", Code: '"+ Code +"' }",
                type: "GET",
                jsonpCallback: "SendGCM",
                contentType: "application/json; charset=utf-8",
                dataType: "jsonp",
                beforeSend: function () {
                    $('#loader').show();
                },
                error: function (xhr, textStatus, err) {
                    var mensaje = "error send to alert. \n";
                    mensaje = mensaje + "readyState: " + xhr.readyState + "\n";
                    mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                    mensaje = mensaje + "status: " + xhr.status + "\n";
                    mensaje = mensaje + "text status: " + textStatus + "\n";
                    mensaje = mensaje + "error: " + err + "\n";
                    //alert(mensaje + err.Message);
                    //navigator.notification.alert(mensaje, function () { }, "BCP Error");
                    //$('#results').html("");
                    $('#loader').hide();
                },
                success: function (obj) {
                    if (obj.SendMsgGCMResult == true) {
                        //*************************
                        //alert('COOP has been activated.')
                        //navigator.notification.alert("COOP has been activated.", function () { }, "BCP Alert");
                        ////*************************
                        //var IdSite = $("#hdnIdSite").val();
                        //var Site = $("#hdnSite").val();
                        //var Latitude = $("#hdnLatitude").val();
                        //var Longitude = $("#hdnLongitude").val();
                        //var KeyBCP = $("#hdnKeywordCOOP").val();
                        ////*************************
                        //window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                        ////*************************
                    } else {
                        alert('Fail');
                    }
                },
                complete: function () {
                    //$('#loader').hide();
                }
            });

        };
        //***************************************
        $(document).on("pageinit", "#map-page", function (event) {
            //***************************************
            var IdCompany = getUrlVars()["IdCompany"];
            var IdSite = getUrlVars()["IdSite"];
            var Site = getUrlVars()["Site"];
            var Latitude = getUrlVars()["Latitude"];
            var Longitude = getUrlVars()["Longitude"];
            var KeyBCP = getUrlVars()["KeyBCP"];
            var Code = window.localStorage["Code"];
            //***************************************
            $("#hdnIdSite").val(IdSite);
            $("#hdnSite").val(unescape(Site));
            $("#hdnLatitude").val(Latitude);
            $("#hdnLongitude").val(Longitude);
            $("#hdnLatitudeCOOP").val(Latitude);
            $("#hdnLongitudeCOOP").val(Longitude);
            $("#hdnKeywordCOOP").val(KeyBCP);
            //***************************************
            var CompanyName = window.localStorage["CompanyName"];
            $("#span1").html("" + CompanyName + " <br/>" + unescape(Site));
            //***************************************
            $("#btnHome").off("click");
            $("#btnHome").click(function () {
                //************************************************
                var IdSite = $("#hdnIdSite").val();
                var Latitude = $("#hdnLatitude").val();
                var Longitude = $("#hdnLongitude").val();
                var Site = $("#hdnSite").val();
                var KeyBCP = $("#hdnKeywordCOOP").val();
                window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                //************************************************
            });
            //************************************************
            $("#btnUp").off("click");
            $("#btnUp").click(function () {
                //************************************************
                if ($("#DivHeader").css('display') == 'block') {
                    $("#DivHeader").hide()
                } else {
                    $("#DivHeader").show()
                }
                //************************************************
            });
            //***************************************
            $("#btnSubmitCOOP").off("click");
            $("#btnSubmitCOOP").click(function () {
                //************************************************
                var IdCompany = window.localStorage["IdCompany"];
                var IdContact = window.localStorage["IdContact"];
                var IdSite = $("#hdnIdSite").val();
                var IdCriticalFunction = $("#ddlCriticalFunction").val();
                var Latitude = $("#hdnLatitudeCOOP").val();
                var Longitude = $("#hdnLongitudeCOOP").val();
                var CommentsCOOP = $("#txtCommentCOOP").val();
                var Code = window.localStorage["Code"];
                //************************************************
                if (IdCriticalFunction == '-1') {
                    navigator.notification.alert("Select critical function", function () { }, "BCP Alert");
                    return false;
                }
                //************************************************
                //if (CommentsCOOP.trim() == '') {
                    //navigator.notification.alert("Enter a comments.", function () { }, "BCP Alert");
                    //return false;
                //}
                //************************************************
                if ($("#txtkeywordCOOP").val().trim() != $("#hdnKeywordCOOP").val().trim()) {
                    navigator.notification.alert("Invalid key!", function () { }, "BCP Alert");
                    return false;
                }
                //************************************************
                var message = 'Warning! If you activate the Continuity of Operations Plan (COOP), our automated system will notify and send alert messages via email to each coordinator of the COOP. Are you sure you want to activate the COOP ?';
                navigator.notification.confirm(
                              message,
                              function (buttonIndex) {// callback a invocar cuando el botón es presionado
                                  if (buttonIndex == 2) {
                                      //************************************************
                                      var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
                                      urlk1 = wcfServiceUrl + "SaveActivateCOOP?IdCompany=" + IdCompany + '&IdContact=' + IdContact + '&IdLocation=' + IdSite + '&IdActivityLoos=' + IdCriticalFunction + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&CommentsCOOP=' + encodeURIComponent(CommentsCOOP) + "&Code=" + Code;
                                      //************************************************
                                      $.ajax({
                                          cache: true,
                                          url: urlk1,
                                          crossDomain: true,
                                          data: "{ IdCompany: " + IdCompany + ", IdContact: " + IdContact + ", IdLocation: " + IdSite + ", IdActivityLoos:" + IdCriticalFunction + ", Latitude: " + Latitude + ", Longitude: " + Longitude + ", CommentsCOOP: " + encodeURIComponent(CommentsCOOP) + ", Code: '"+ Code +"' }",
                                          type: "GET",
                                          jsonpCallback: "ActivateCOOP",
                                          contentType: "application/json; charset=utf-8",
                                          dataType: "jsonp",
                                          beforeSend: function () {
                                              $('#loader').show();
                                          },
                                          error: function (xhr, textStatus, err) {
                                              var mensaje = "readyState: " + xhr.readyState + "\n";
                                              mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                                              mensaje = mensaje + "status: " + xhr.status + "\n";
                                              mensaje = mensaje + "text status: " + textStatus + "\n";
                                              mensaje = mensaje + "error: " + err + "\n";
                                              alert(mensaje);
                                              //navigator.notification.alert(mensaje, function () { }, "BCP Error");
                                              $('#loader').hide();
                                          },
                                          success: function (obj) {
                                              //******************************
                                              if (obj.SaveActivateCOOPResult == true) {
                                                  //*************************
                                                  var Message = window.localStorage["ContactName"] + ' has activated COOP for ' + $("#ddlCriticalFunction option:selected").text();
                                                  //*************************
                                                  $("#ddlCriticalFunction").val('-1');
                                                  $("#txtCommentCOOP").val('');
                                                  //*************************
                                                  SendMessageAPNSMobile(window.localStorage["IdCompany"], $("#hdnIdSite").val(), Message, 'COOP', window.localStorage["Code"]);
                                                  //*************************
                                                  //alert('COOP has been activated.')
                                                  navigator.notification.alert("COOP has been activated", function () { }, "BCP Mobile");
                                                  //*************************
                                                  var IdSite = $("#hdnIdSite").val();
                                                  var Site = $("#hdnSite").val();
                                                  var Latitude = $("#hdnLatitude").val();
                                                  var Longitude = $("#hdnLongitude").val();
                                                  var KeyBCP = $("#hdnKeywordCOOP").val();
                                                  //*************************
                                                  window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                                                  //*************************
                                              } else {
                                                  alert('fail')
                                              }
                                              //******************************
                                          },
                                          complete: function () {
                                              $('#loader').hide();
                                          }
                                      });
                                      //***************************************
                                  }
                              },
                              'Activation COOP', // titulo de la ventana
                              'Cancel,Yes' // etiquetas de los botones
                        );
                return false;
                ////************************************************
                //if (confirm('Warning! If you activate the Continuity of Operations Plan (COOP), our automated system will notify and send alert messages via email to each coordinator of the COOP. Are you sure you want to activate the COOP ?')) {
                //    //************************************************
                //    var wcfServiceUrl = "http://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
                //    urlk1 = wcfServiceUrl + "SaveActivateCOOP?IdCompany=" + IdCompany + '&IdContact=' + IdContact + '&IdLocation=' + IdSite + '&IdActivityLoos=' + IdCriticalFunction + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&CommentsCOOP=' + encodeURIComponent(CommentsCOOP);
                //    //************************************************
                //    $.ajax({
                //        cache: true,
                //        url: urlk1,
                //        crossDomain: true,
                //        data: "{ IdCompany: " + IdCompany + ", IdContact: " + IdContact + ", IdLocation: " + IdSite + ", IdActivityLoos:" + IdCriticalFunction + ", Latitude: " + Latitude + ", Longitude: " + Longitude + ", CommentsCOOP: " + encodeURIComponent(CommentsCOOP) + " }",
                //        type: "GET",
                //        jsonpCallback: "ActivateCOOP",
                //        contentType: "application/json; charset=utf-8",
                //        dataType: "jsonp",
                //        beforeSend: function () {
                //            $('#loader').show();
                //        },
                //        error: function (xhr, textStatus, err) {
                //            var mensaje = "readyState: " + xhr.readyState + "\n";
                //            mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                //            mensaje = mensaje + "status: " + xhr.status + "\n";
                //            mensaje = mensaje + "text status: " + textStatus + "\n";
                //            mensaje = mensaje + "error: " + err + "\n";
                //            alert(mensaje);
                //            //navigator.notification.alert(mensaje, function () { }, "BCP Error");
                //            $('#loader').hide();
                //        },
                //        success: function (obj) {
                //            //******************************
                //            if (obj.SaveActivateCOOPResult == true) {
                //                //*************************
                //                var Message = window.localStorage["ContactName"] + ' has activated COOP for ' + $("#ddlCriticalFunction option:selected").text();
                //                //*************************
                //                $("#ddlCriticalFunction").val('-1');
                //                $("#txtCommentCOOP").val('');
                //                //*************************
                //                SendMessageAPNSMobile(window.localStorage["IdCompany"], $("#hdnIdSite").val(), Message, 'COOP');
                //                //*************************
                //                //alert('COOP has been activated.')
                //                navigator.notification.alert("COOP has been activated", function () { }, "BCP Mobile");
                //                //*************************
                //                var IdSite = $("#hdnIdSite").val();
                //                var Site = $("#hdnSite").val();
                //                var Latitude = $("#hdnLatitude").val();
                //                var Longitude = $("#hdnLongitude").val();
                //                var KeyBCP = $("#hdnKeywordCOOP").val();
                //                //*************************
                //                window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                //                //*************************
                //            } else {
                //                alert('fail')
                //            }
                //            //******************************
                //        },
                //        complete: function () {
                //            $('#loader').hide();
                //        }
                //    });
                //    //***************************************
                //}

            });
            //***************************************
            var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
            urlk1 = wcfServiceUrl + "ListCriticalFunction?IdCompany=" + IdCompany + '&IdSite=' + IdSite + "&Code=" + Code;
            //***************************************
            $.ajax({
                cache: true,
                url: urlk1,
                crossDomain: true,
                data: "{ IdCompany: " + IdCompany + ", IdSite: " + IdSite + ", Code: " + Code + " }",
                type: "GET",
                jsonpCallback: "lsobjCriticalFunction",
                contentType: "application/json; charset=utf-8",
                dataType: "jsonp",
                beforeSend: function () {
                    $('#loader').show();
                },
                error: function (xhr, textStatus, err) {
                    var mensaje = "readyState: " + xhr.readyState + "\n";
                    mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                    mensaje = mensaje + "status: " + xhr.status + "\n";
                    mensaje = mensaje + "text status: " + textStatus + "\n";
                    mensaje = mensaje + "error: " + err + "\n";
                    alert(mensaje);
                    //navigator.notification.alert(mensaje, function () { }, "BCP Error");
                    $('#ddlCriticalFunction').html("");
                    $('#loader').hide();
                },
                success: function (obj) {
                    //******************************
                    $('#ddlCriticalFunction').html("");
                    //******************************
                    $("#ddlCriticalFunction")
                        .append($("<option selected='selected'></option>")
                        .val('-1')
                        .html('Select')
                        .attr("title", 'Select'));
                    //******************************
                    $.each(obj.ListCriticalFunctionResult, populateDropdown);
                    //******************************
                    $("#ddlCriticalFunction").val('-1');
                    //******************************
                },
                complete: function () {
                    $('#loader').hide();
                }
            });
            //***************************************
        });
        //***************************************
        window.onload = function () {

        }
        //***************************************
    </script>

</head>
<body>
    <div data-role="page" id="map-page" data-url="map-page">
        <div data-role="header" data-position="fixed" style="background-color:#0065B3;color:white;font-size:11px;font-weight:normal;vertical-align:super;">
            <a href="#" id="btnHome" class="ui-btn ui-shadow ui-corner-all ui-icon-carat-l ui-btn-icon-notext" style="background-color:#0065B3;position:-ms-page;top: 12px !important;" data-role="button" role="button"></a>
            <a href="#" id="btnUp" class="ui-btn ui-corner-all ui-shadow ui-btn-icon-left ui-btn-icon-notext">V</a>
            <h1 id="span1"></h1>
            <div id="DivHeader" data-role="collapsible-set" style="display:none;">
                <table style="color:#0065B3;">
                    <tr>
                        <td>
                            <div data-role="fieldcontain">
                                <label for="txtkeywordCOOP" class="select"></label>
                                <input type="text" id="txtkeywordCOOP" placeholder="keyword COOP">
                            </div>
                        </td>
                        <td>
                            <div data-role="fieldcontain">
                                <label for="ddlCriticalFunction" class="select"></label>
                                <select id="ddlCriticalFunction" placeholder="Select Hazard"></select>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div data-role="fieldcontain">
                                <label for="txtComment" class="select"></label>
                                <textarea id="txtCommentCOOP" placeholder="Comments COOP"></textarea>
                            </div>
                        </td>
                        <td>
                            <input type="button" id="btnSubmitCOOP" data-icon="star" data-theme="a" data-form="ui-btn-up-a" value="Activate COOP" />
                        </td>
                    </tr>
                </table>
            </div>
                <div id="loader" style="display:none;">
                    <div id="center">
                        <img src="images/ajax-loader.gif" />
                    </div>
                </div>
            </div>
        <div role="main" class="ui-content" id="map-canvas">
            <!-- map loads here... -->
        </div>
        <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
            ©BCP Insight Risk Technologies,LLC <span class="jqm-version"></span>
        </div>
        <script type="text/javascript">
            app.initialize();
        </script>
    </div>
    <input type="hidden" id="hdnIdSite" />
    <input type="hidden" id="hdnSite" />
    <input type="hidden" id="hdnLatitude" />
    <input type="hidden" id="hdnLongitude" />
    <input type="hidden" id="hdnLatitudeCOOP" />
    <input type="hidden" id="hdnLongitudeCOOP" />
    <input type="hidden" id="hdnKeywordCOOP" />
</body>
</html>