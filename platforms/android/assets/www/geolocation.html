<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Reverse Geocoding</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <!--<script type="text/javascript" src="cordova.js"></script>-->
    <script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 5px;
            padding: 0px;
        }
        #map-canvas {
            height: 100%;
            margin: 10px;
            padding: 0px;
        }
    </style>
    <!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>-->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript">

        var geocoder;
        var map;
        var infowindow = new google.maps.InfoWindow();

        google.maps.event.addDomListener(window, 'load', initialize);

        function initialize() {
            geocoder = new google.maps.Geocoder();
            var latlng = new google.maps.LatLng(38.96130,-0.583331);
            var mapOptions = {
              zoom: 15,
              center: latlng,
              mapTypeId: 'roadmap'
            }
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        }

        function codeLatLng() {
        var input = document.getElementById('geolocation').innerHTML;
        var latlngStr = input.split(',', 2);
        var lat = parseFloat(latlngStr[0]);
        var lng = parseFloat(latlngStr[1]);
        var latlng = new google.maps.LatLng(lat, lng);
        geocoder.geocode({'latLng': latlng}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
            if (results[1]) {
                map.setZoom(17);
                infowindow.setContent(results[1].formatted_address);
                infowindow.open(map, marcadorUsuario);
            }
            else {
                navigator.notification.alert('No ha encontrado resultados');
            }
            }
            else {
            navigator.notification.alert('Ningún resultado encontrado: ' + status);
            }
        });
        }

        //setInterval(codeLatLng,5000);

        var registrandoPosicion = false,
        idRegistroPosicion,
        ultimaPosicionUsuario,
        marcadorUsuario,
        div = document.getElementById('map-canvas');

        function registrarPosicion() {
            if (registrandoPosicion){
                registrandoPosicion = false;
                navigator.geolocation.clearWatch(idRegistroPosicion);
                limpiarUbicacion();
            }
            else {
                idRegistroPosicion = navigator.geolocation.watchPosition(
                    exitoRegistroPosicion,
                    falloRegistroPosicion,
                    {
                        enableHighAccuracy : true,
                        maximumAge : 60000, //Milisegundos
                        timeout : 30000 //Milisegundos
                    }
                );
            }
        }

        function exitoRegistroPosicion(position) {
            //alert('exitoRegistroPosicion');
            if (!registrandoPosicion) {
                registrandoPosicion = true;
                ultimaPosicionUsuario = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                marcadorUsuario = new google.maps.Marker({
                    position : ultimaPosicionUsuario,
                    map : map
                });
            }
            else {
                var posicionActual = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                if (google.maps.geometry.spherical.computeDistanceBetween(posicionActual, ultimaPosicionUsuario) > 2){//Metros de distancia entre la ultima posicion y la posicion actual
                    ultimaPosicionUsuario = posicionActual;
                    marcadorUsuario.setPosition(posicionActual);
                }
            }
            var element = document.getElementById('geolocation');
            element.innerHTML = position.coords.latitude + ',' + position.coords.longitude;
            map.panTo(ultimaPosicionUsuario);
            //navigator.geolocation.getCurrentPosition(onSuccess, onError);
        }

        function falloRegistroPosicion() {
            navigator.notification.alert('No se pudo determinar la ubicación');
            limpiarUbicacion();
        }

        function limpiarUbicacion() {
            ultimaPosicionUsuario = new google.maps.LatLng(0,0);
            if (marcadorUsuario){
                marcadorUsuario.setMap(null);
                marcadorUsuario = null;
            }
        }

        function onSuccess(position) {
          var element = document.getElementById('geolocation');
          element.innerHTML = position.coords.latitude + ',' + position.coords.longitude;
        }

        function onError(error) {
          navigator.notification.alert('code: '    + error.code    + '\n' +
                             'message: ' + error.message + '\n');
        }

    </script>
</head>
<body id="pageGeolocation" onLoad="registrarPosicion()">
    <div>
        <input type="button" value="Actualizar posición" onclick="registrarPosicion()">
        <div style="display:none;">
            <p id="geolocation"></p> <!--Aqui se muestran las coordenadas que recibe el dispositivo-->
        </div>
    </div>
    <div id="map-canvas"></div>

</body>
</html>