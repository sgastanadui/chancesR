<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--<meta http-equiv="refresh" content="10" />-->
    <title></title>
    <link href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/common.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript">

    var oldpath;
    var lastIndx = 0;
    var arr = new Array();

    window.onload = function () {
        //*********************************
        var IdCompany = getUrlVars()["IdCompany"];
        var IdSite = getUrlVars()["IdSite"];
        var IdHazard = getUrlVars()["IdHazard"];
        var IdContact = getUrlVars()["IdContact"];
        var IdAlert = getUrlVars()["IdAlert"];
        var pathFutureCoordinates = new Array();
        var Latitude, Longitude;
        //*********************************
        var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
        var urlk1 = wcfServiceUrl + "ListHistoryGPSUser?IdCompany=" + IdCompany + "&IdSite=" + IdSite + "&IdHazard=" + IdHazard + "&IdContact=" + IdContact + "&IdAlert=" + IdAlert;
        //************************************************************
        $.ajax({
            //cache: true,
            async: false,
            url: urlk1,
            crossDomain: true,
            data: "{ IdCompany: " + IdCompany + " }",
            type: "GET",
            jsonpCallback: "lsobjHistoryGPS",
            contentType: "application/json; charset=utf-8",
            dataType: "jsonp",
            beforeSend: function () {
                $('#loader').show();
            },
            error: function (xhr, textStatus, err) {
                var mensaje = "readyState: " + xhr.readyState + "\n";
                mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                mensaje = mensaje + "status: " + xhr.status + "\n";
                mensaje = mensaje + "text status: " + textStatus + "\n";
                mensaje = mensaje + "error: " + err + "\n";
                navigator.notification.alert(mensaje, function () { }, "BCP Error");
                $('#loader').hide();
            },
            success: function (obj) {
                //******************************
                for (var i = 0; i < obj.ListHistoryGPSUserResult.length; i++) {
                    var valueToPush = {}; // or "var valueToPush = new Object();" which is the same
                    valueToPush["lat"] = obj.ListHistoryGPSUserResult[i].Latitude;
                    valueToPush["lng"] = obj.ListHistoryGPSUserResult[i].Longitude;
                    arr.push(valueToPush);
                }
                if (obj.ListHistoryGPSUserResult.length > 0) {
                    Latitude = obj.ListHistoryGPSUserResult[0].Latitude;
                    Longitude = obj.ListHistoryGPSUserResult[0].Longitude;
                }
                //******************************
                initialize(arr, Latitude, Longitude);
                //******************************
            },
            complete: function () {
                $('#loader').hide();
            }
        });
    }

    function gDirRequest(service, waypoints, userFunction, waypointIndex, path) {
        // set defaults

        waypointIndex = typeof waypointIndex !== 'undefined' ? waypointIndex : 0;
        path = typeof path !== 'undefined' ? path : [];

        // get next set of waypoints
        var s = gDirGetNextSet(waypoints, waypointIndex);
        // build request object
        var startl = s[0].shift()["location"];
        var endl = s[0].pop()["location"];
        var request = {
            origin: startl,
            destination: endl,
            waypoints: s[0],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            optimizeWaypoints: false,
            provideRouteAlternatives: false,
            avoidHighways: false,
            avoidTolls: false
        };
        service.route(request, function(response, status) {

            if (status == google.maps.DirectionsStatus.OK) {
                path = path.concat(response.routes[0].overview_path);
                oldpath = path
                if (s[1] != null) {
			        lastIndx = s[1]
                    gDirRequest(service, waypoints, userFunction, s[1], path)
                } else {
                    userFunction(path);
                }

            } else {
			        path = oldpath;
			        lastIndx = lastIndx+1
			        if (s[lastIndx]!= null) {
			        gDirRequest(service, waypoints, userFunction,lastIndx , path)
			    }
			    else{
			        userFunction(path);
			    }
            }

        });
    }

    function gDirGetNextSet (waypoints, startIndex) {
        var MAX_WAYPOINTS_PER_REQUEST = 8;

        var w = [];    // array of waypoints to return

        if (startIndex > waypoints.length - 1) { return [w, null]; } // no more waypoints to process

        var endIndex = startIndex + MAX_WAYPOINTS_PER_REQUEST;

        // adjust waypoints, because Google allows us to include the start and destination latlongs for free!
        endIndex += 2;

        if (endIndex > waypoints.length - 1) { endIndex = waypoints.length ; }

        for (var i = startIndex; i < endIndex; i++) {
            w.push(waypoints[i]);
        }

        if (endIndex != waypoints.length) {
            return [w, endIndex -= 1];
        } else {
            return [w, null];
        }
    }

    function main(data) {

        // initalise directions service
        var directionsService = new google.maps.DirectionsService();

        var travelWaypoints = []
	    for (var i=0;i<=data.length-1;++i){
	       travelWaypoints.push({location: new google.maps.LatLng(data[i].lat,data[i].lng)})
	    }

        // get directions and draw on map
        gDirRequest(directionsService, travelWaypoints, function drawGDirLine(path) {
            var line = new google.maps.Polyline({ clickable: false, map: map, path: path });
            //***************************************************
            var lineSymbol = {
                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
            };
            var carPolyline = new google.maps.Polyline({
                map: map,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                icons: [{
                    icon: lineSymbol,
                    offset: '100%'
                }],
            });
            var carPath = new google.maps.MVCArray();
            for (var i = 0; i < path.length; i++) {
                if (i === 0) {
                    carPath.push(path[i]);
                    carPolyline.setPath(carPath);
                } else {
                    setTimeout((function (latLng) {
                        return function () {
                            carPath.push(latLng);
                        };
                    })(path[i]), 300 * i);
                }
            }
            //***************************************************
        });
    }

    var map;

    function initialize(data,mid_lat,mid_lon) {
        var mapOptions = {
            center: new google.maps.LatLng(mid_lat, mid_lon),
            zoom: 16,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            backgroundColor: '#ffffff',
            noClear: true,
            disableDefaultUI: false,
            keyboardShortcuts: true,
            disableDoubleClickZoom: false,
            draggable: true,
            scrollwheel: true,
            draggableCursor: 'pointer',
            draggingCursor: 'crosshair',
            mapTypeControl: true,
            panControl: true,
            panControlOptions: {
                position: google.maps.ControlPosition.TOP_RIGHT
            },
            navigationControl: true,
            streetViewControl: true,
            streetViewControlOptions: {
                position: google.maps.ControlPosition.RIGHT_TOP
            },
            navigationControlOptions: {
                position: google.maps.ControlPosition.TOP_LEFT,
                style: google.maps.NavigationControlStyle.ANDROID
            },
            scaleControl: true,
            zoomControlOptions: {
                //style: google.maps.ZoomControlStyle.LARGE,
                position: google.maps.ControlPosition.RIGHT_TOP
            }
        };

        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        google.maps.event.addListenerOnce(map, 'idle', function(){
            main(data);
            //autoRefresh(map);
        });
    }

    function moveMarker(map, marker, latlng) {
        marker.setPosition(latlng);
        map.panTo(latlng);
    }

    function autoRefresh(map) {
        var i, route, marker;
        route = new google.maps.Polyline({
            path: [],
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2,
            editable: false,
            map: map
        });

        marker = new google.maps.Marker({ map: map, icon: "http://maps.google.com/mapfiles/ms/micons/blue.png" });
        for (i = 0; i < arr.length; i++) {
            setTimeout(function (coords) {
                var latlng = new google.maps.LatLng(coords.lat, coords.lng);
                route.getPath().push(latlng);
                moveMarker(map, marker, latlng);
            }, 200 * i, arr[i]);
        }
    }

    function animateCircle(line) {
        var count = 0;
        window.setInterval(function () {
            count = (count + 1) % 200;
            var icons = line.get('icons');
            icons[0].offset = (count / 2) + '%';
            line.set('icons', icons);
        }, 2000);
    }
    //***************************************

    //***************************************
    $(document).on("pageinit", "#map-page2", function (event) {
        //***************************************
        var IdAlertsERT = getUrlVars()["IdAlert"];
        var IdCompany = getUrlVars()["IdCompany"];
        var IdSite = getUrlVars()["IdSite"];
        var Site = getUrlVars()["Site"];
        var KeyBCP = getUrlVars()["KeyBCP"];
        var Latitude = '';
        var Longitude = '';
        //***************************************
        $("#hdnIdAlertsERT").val(IdAlertsERT);
        $("#hdnIdSite").val(IdSite);
        $("#hdnKeyword").val(KeyBCP);
        $("#hdnSite").val(unescape(Site));
        $("#hdnLatitude").val(Latitude);
        $("#hdnLongitude").val(Longitude);
        //***************************************
        var CompanyName = window.localStorage["CompanyName"];
        $("#span1").html("" + CompanyName + " <br/>" + unescape(Site));
        //***************************************
        $("#btnHome").off("click");
        $("#btnHome").click(function () {
            //************************************************
            var IdCompany = window.localStorage["IdCompany"];
            var IdSite = $("#hdnIdSite").val();
            var Site = $("#hdnSite").val();
            var KeyBCP = $("#hdnKeyword").val();
            var Latitude = $("#hdnLatitude").val();
            var Longitude = $("#hdnLongitude").val();
            window.location.href = 'home.html?IdCompany=' + IdCompany + '&IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
            //************************************************
        });
        //***************************************
        $("#btnRefresh").off("click");
        $("#btnRefresh").click(function () {
            //************************************************
            var IdCompany = window.localStorage["IdCompany"];
            var IdSite = $("#hdnIdSite").val();
            var Site = $("#hdnSite").val();
            var KeyBCP = $("#hdnKeyword").val();
            var Latitude = $("#hdnLatitude").val();
            var Longitude = $("#hdnLongitude").val();
            var IdHazard = getUrlVars()["IdHazard"];
            var IdContact = getUrlVars()["IdContact"];
            var IdAlert = getUrlVars()["IdAlert"];
            //window.location.href = 'home.html?IdCompany=' + IdCompany + '&IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
            window.location.href = 'geo.html?IdAlert=' + IdAlert + '&IdCompany=' + IdCompany + '&IdSite=' + IdSite + '&IdHazard=' + IdHazard + '&IdContact=' + IdContact + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
            //************************************************
        });
        //***************************************
    });
    //***************************************

    </script>
</head>
<body>
    <div data-role="page" id="map-page2" data-url="map-page2">
        <div data-role="header" data-position="fixed" style="background-color:#0065B3;color:white;font-size:11px;font-weight:normal;">
            <h1 id="span1"></h1>
            <a href="#" id="btnHome" class="ui-btn ui-shadow ui-corner-all ui-icon-carat-l ui-btn-icon-notext" style="background-color:#0065B3;position:-ms-page;top: 12px !important;" data-role="button" role="button"></a>
            <a href="#" id="btnRefresh" class="ui-btn ui-icon-navigation ui-btn-icon-left" style="background-color:#0065B3;position:-ms-page;top: 17px !important;" data-role="button" role="button"></a>
        </div>
        <div role="main" class="ui-content" id="map-canvas">
            <!-- map loads here... -->
        </div>
        <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
            ©BCP Insight Risk Technologies,LLC <span class="jqm-version"></span>
        </div>
        <!-- Div Loading -->
        <div id="loader" style="display:none;">
            <div id="center">
                <img src="images/ajax-loader.gif" />
            </div>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
        <input type="hidden" id="hdnIdAlertsERT" />
        <input type="hidden" id="hdnIdSite" />
        <input type="hidden" id="hdnSite" />
        <input type="hidden" id="hdnKeyword" />
        <input type="hidden" id="hdnLatitude" />
        <input type="hidden" id="hdnLongitude" />
    </div>
</body>
</html>