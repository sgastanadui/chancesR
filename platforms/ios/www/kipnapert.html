<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sites</title>
    <!-- InsightBCPMobile references -->
    <link href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/common.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript">
        //***************************************
        var geocoder;
        var map;
        var infowindow = new google.maps.InfoWindow();
        //***************************************
        var registrandoPosicion = false,
        idRegistroPosicion,
        ultimaPosicionUsuario,
        marcadorUsuario,
        div = document.getElementById('map-canvas');
        //***************************************
        $(document).on("pagecreate", "#map-page", function () {
            //*********************************
            var longitude = getUrlVars()["Longitude"];
            var latitude = getUrlVars()["Latitude"];
            var Site = getUrlVars()["Site"];
            //*********************************
            geocoder = new google.maps.Geocoder();
            var defaultLatLng = new google.maps.LatLng(latitude, longitude);  // Default to Hollywood, CA when no geolocation support
            //*********************************
            if (navigator.geolocation) {
                //***************************************
                function success(pos) {
                    // Location found, show map with these coordinates
                    var element = document.getElementById('geolocation');
                    element.innerHTML = pos.coords.latitude + ',' + pos.coords.longitude;
                    $("#hdnLatitudeERT").val(pos.coords.latitude);
                    $("#hdnLongitudeERT").val(pos.coords.longitude);
                    drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                }
                //***************************************
                function fail(error) {
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            navigator.notification.alert("User denied the request for Geolocation.", function () { }, "BCP Error");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            navigator.notification.alert("Location information is unavailable.", function () { }, "BCP Error");
                            break;
                        case error.TIMEOUT:
                            navigator.notification.alert("The request to get user location timed out.", function () { }, "BCP Error");
                            break;
                        case error.UNKNOWN_ERROR:
                            navigator.notification.alert("An unknown error occurred.", function () { }, "BCP Error");
                            break;
                    }
                    drawMap(defaultLatLng);  // Failed to find location, show default map
                }
                //***************************************
                // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
                navigator.geolocation.getCurrentPosition(success, fail, { maximumAge: 500000, enableHighAccuracy: true, timeout: 6000 });
                //***************************************
            } else {
                drawMap(defaultLatLng);  // No geolocation support, show default map
            }

            function drawMap(latlng) {
                var myOptions = {
                    zoom: 25,
                    center: latlng,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    backgroundColor: '#ffffff',
                    noClear: true,
                    disableDefaultUI: false,
                    keyboardShortcuts: true,
                    disableDoubleClickZoom: false,
                    draggable: true,
                    scrollwheel: true,
                    draggableCursor: 'pointer',
                    draggingCursor: 'crosshair',
                    mapTypeControl: true,
                    panControl: true,
                    panControlOptions: {
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },
                    navigationControl: true,
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    navigationControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP,
                        style: google.maps.NavigationControlStyle.ANDROID
                    },
                    scaleControl: true,
                    scaleControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP,
                        style: google.maps.ScaleControlStyle.DEFAULT
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        //style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.RIGHT_TOP
                    }
                };

                map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

                ////Add an overlay to the map of current lat/lng
                //marcadorUsuario = new google.maps.Marker({
                //    position: latlng,
                //    map: map,
                //    animation: google.maps.Animation.DROP,
                //    title: 'Current Location',
                //    cursor: 'pointer',
                //    draggable: false,
                //    icon: 'images/bluecircle.png'
                //});

                var input = document.getElementById('geolocation').innerHTML;
                var latlngStr = input.split(',', 2);
                var lat = parseFloat(latlngStr[0]);
                var lng = parseFloat(latlngStr[1]);
                var latlng = new google.maps.LatLng(lat, lng);
                geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (results[1]) {
                            //map.setZoom(17);
                            infowindow.setContent(results[1].formatted_address);
                            infowindow.open(map, marcadorUsuario);
                        }
                        else {
                            navigator.notification.alert('No ha encontrado resultados');
                        }
                    }
                    else {
                        navigator.notification.alert('Ningún resultado encontrado: ' + status);
                    }
                });

                //var Site = getUrlVars()["Site"];
                //var contentString = '<div id="content">' + unescape(Site) + '</div>';
                //var infowindowSite = new google.maps.InfoWindow({
                //    content: contentString
                //});
                //************************
                //infowindowSite.open(map, marker);
                //************************
            }

            function codeLatLng() {
                var input = document.getElementById('geolocation').innerHTML;
                var latlngStr = input.split(',', 2);
                var lat = parseFloat(latlngStr[0]);
                var lng = parseFloat(latlngStr[1]);
                var latlng = new google.maps.LatLng(lat, lng);
                geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (results[1]) {
                            //map.setZoom(17);
                            infowindow.setContent(results[1].formatted_address);
                            infowindow.open(map, marcadorUsuario);
                            //registrarPosicion();
                        }
                        else {
                            navigator.notification.alert('No ha encontrado resultados');
                        }
                    }
                    else {
                        navigator.notification.alert('Ningún resultado encontrado: ' + status);
                    }
                });
            }

            setInterval(codeLatLng, 30000);

            function registrarPosicion() {
                if (registrandoPosicion) {
                    registrandoPosicion = false;
                    navigator.geolocation.clearWatch(idRegistroPosicion);
                    limpiarUbicacion();
                }
                else {
                    //idRegistroPosicion = navigator.geolocation.getCurrentPosition(
                    //    exitoRegistroPosicion,
                    //    falloRegistroPosicion,
                    //    {
                    //        maximumAge: 500000,
                    //        enableHighAccuracy: true,
                    //        timeout: 6000
                    //    });
                    idRegistroPosicion = navigator.geolocation.watchPosition(
                        exitoRegistroPosicion,
                        falloRegistroPosicion,
                        {
                            enableHighAccuracy: true,
                            maximumAge: 60000, //Milisegundos
                            timeout: 6000 //Milisegundos
                        }
                    );
                }
            }

            function exitoRegistroPosicion(position) {
                if (!registrandoPosicion) {
                    registrandoPosicion = true;
                    ultimaPosicionUsuario = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    marcadorUsuario = new google.maps.Marker({
                        position: ultimaPosicionUsuario,
                        map: map
                    });
                }
                else {
                    var posicionActual = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    if (google.maps.geometry.spherical.computeDistanceBetween(posicionActual, ultimaPosicionUsuario) > 2) {//Metros de distancia entre la ultima posicion y la posicion actual
                        ultimaPosicionUsuario = posicionActual;
                        marcadorUsuario.setPosition(posicionActual);
                    }
                }
                map.panTo(ultimaPosicionUsuario);
                $("#hdnLatitudeERT").val(ultimaPosicionUsuario.coords.latitude);
                $("#hdnLongitudeERT").val(ultimaPosicionUsuario.coords.longitude);
                //navigator.geolocation.getCurrentPosition(onSuccess, onError);
            }

            function falloRegistroPosicion() {
                navigator.notification.alert('No se pudo determinar la ubicación');
                limpiarUbicacion();
            }

            function limpiarUbicacion() {
                ultimaPosicionUsuario = new google.maps.LatLng(0, 0);
                if (marcadorUsuario) {
                    marcadorUsuario.setMap(null);
                    marcadorUsuario = null;
                }
            }
        });
        //***************************************
        populateDropdown = function (data) {
            var IdHazard, HazardName;
            IdHazard = this.IdHazard;
            HazardName = this.HazardName;
            $("#ddlHazard")
                .append($("<option></option>")
                .val(IdHazard)
                .html(HazardName)
                .attr("title", HazardName));
        };
        //***************************************
        SendMessageGCMMobile = function (IdCompany, IdSite, Message, xType, Code) {
            //***************************************
            var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
            //***************************************
            var urlk1 = wcfServiceUrl + "SendMsgGCM?IdCompany=" + IdCompany + '&IdSite=' + IdSite + '&Message=' + Message + '&xType=' + xType + '&Code=' + Code;
            //***************************************
            $.ajax({
                cache: true,
                async: true,
                url: urlk1,
                crossDomain: true,
                data: "{ IdCompany: " + IdCompany + ", IdSite: " + IdSite + ", Message: " + Message + ", xType: " + xType + ", Code: '"+ Code +"' }",
                type: "GET",
                jsonpCallback: "SendGCM",
                contentType: "application/json; charset=utf-8",
                dataType: "jsonp",
                beforeSend: function () {
                    //$("#imgAjaxLoader").show();
                    $('#loader').show();
                },
                error: function (xhr, textStatus, err) {
                    var mensaje = "error send to alert. \n";
                    mensaje = mensaje + "readyState: " + xhr.readyState + "\n";
                    mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                    mensaje = mensaje + "status: " + xhr.status + "\n";
                    mensaje = mensaje + "text status: " + textStatus + "\n";
                    mensaje = mensaje + "error: " + err + "\n";
                    //alert(mensaje + err.Message);
                    //navigator.notification.alert(mensaje, function () { }, "BCP Error");
                    //$('#results').html("");
                    $('#loader').hide();
                },
                success: function (obj) {
                    if (obj.SendMsgGCMResult == true) {
                        ////*************************
                        //alert('ERP has been activated.')
                        ////navigator.notification.alert("ERP has been activated.", function () { }, "BCP Alert");
                        ////*************************
                        //var IdSite = $("#hdnIdSite").val();
                        //var Site = $("#hdnSite").val();
                        //var Latitude = $("#hdnLatitude").val();
                        //var Longitude = $("#hdnLongitude").val();
                        //var KeyBCP = $("#hdnKeywordERT").val();
                        ////*************************
                        //window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                        ////*************************
                    } else {
                        alert('Fail');
                    }
                },
                complete: function () {
                    //$("#imgAjaxLoader").hide();
                    //$('#loader').hide();
                }
            });

        }
        //***************************************
        $(document).on("pageinit", "#map-page", function (event) {
        //***************************************
        var IdCompany = getUrlVars()["IdCompany"];
        var IdSite = getUrlVars()["IdSite"];
        var Site = getUrlVars()["Site"];
        var Latitude = getUrlVars()["Latitude"];
        var Longitude = getUrlVars()["Longitude"];
        var KeyBCP = getUrlVars()["KeyBCP"];
        var IdEvent = getUrlVars()["IdEvent"];
        var Code = window.localStorage["Code"];
        //***************************************
        $("#hdnIdSite").val(IdSite);
        $("#hdnSite").val(unescape(Site));
        $("#hdnLatitude").val(Latitude);
        $("#hdnLongitude").val(Longitude);
        $("#hdnLatitudeERT").val(Latitude);
        $("#hdnLongitudeERT").val(Longitude);
        $("#hdnKeywordERT").val(KeyBCP);
        $("#hdnIdEvent").val(IdEvent);
        //***************************************
        var CompanyName = window.localStorage["CompanyName"];
        $("#span1").html("" + CompanyName + " <br/>" + unescape(Site));
        //***************************************
        $("#btnHome").off("click");
        $("#btnHome").click(function () {
            //************************************************
            var IdSite = $("#hdnIdSite").val();
            var Latitude = $("#hdnLatitude").val();
            var Longitude = $("#hdnLongitude").val();
            var Site = $("#hdnSite").val();
            var KeyBCP = $("#hdnKeywordERT").val();
            window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
            //************************************************
        });
        $("#btnUp").off("click");
        $("#btnUp").click(function () {
            //************************************************
            if ($("#DivHeader").css('display') == 'block') {
                $("#DivHeader").hide()
            } else {
                $("#DivHeader").show()
            }
            //************************************************
        });
        //***************************************
        $("#btnSubmitERP").off("click");
        $("#btnSubmitERP").click(function () {
            //************************************************
            var IdCompany = window.localStorage["IdCompany"];
            var IdContact = window.localStorage["IdContact"];
            var IdSite = $("#hdnIdSite").val();
            var IdHazard = $("#ddlHazard").val();
            var Latitude = $("#hdnLatitudeERT").val();
            var Longitude = $("#hdnLongitudeERT").val();
            var CommentsERP = $("#txtCommentERP").val();
            //************************************************
            if (IdHazard == '-1') {
                //alert('Select hazard');
                navigator.notification.alert("Select hazard.", function () { }, "BCP Alert");
                return false;
            }
            //************************************************
            if ($("#txtkeywordERT").val().trim() != $("#hdnKeywordERT").val().trim()) {
                //alert('Invalid key');
                navigator.notification.alert("Invalid key!", function () { }, "BCP Alert");
                return false;
            }
            //************************************************
            if (confirm('Warning! If you activate the ERP, our automated system will notify and send alert messages via email to each member of the Emergency Response Team (ERT). Are you sure you want to activate the ERP ?')) {
                //************************************************
                var wcfServiceUrl = "http://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
                //var wcfServiceUrl = "http://localhost:10786/InsightBCPWDSL.svc/";
                urlk1 = wcfServiceUrl + "SaveActivateERT?IdCompany=" + IdCompany + '&IdContact=' + IdContact + '&IdLocation=' + IdSite + '&IdHazard=' + IdHazard + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&CommentsERP=' + encodeURIComponent(CommentsERP);
                //************************************************
                $.ajax({
                    cache: true,
                    url: urlk1,
                    crossDomain: true,
                    data: "{ IdCompany: " + IdCompany + ", IdContact: " + IdContact + ", IdLocation: " + IdSite + ", IdHazard:" + IdHazard + ", Latitude: " + Latitude + ", Longitude: " + Longitude + ", CommentsERP: " + encodeURIComponent(CommentsERP) + " }",
                    type: "GET",
                    jsonpCallback: "ActivateERP",
                    contentType: "application/json; charset=utf-8",
                    dataType: "jsonp",
                    beforeSend: function () {
                        $('#loader').show();
                    },
                    error: function (xhr, textStatus, err) {
                        var mensaje = "readyState: " + xhr.readyState + "\n";
                        mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                        mensaje = mensaje + "status: " + xhr.status + "\n";
                        mensaje = mensaje + "text status: " + textStatus + "\n";
                        mensaje = mensaje + "error: " + err + "\n";
                        alert(mensaje);
                        //navigator.notification.alert(mensaje, function () { }, "BCP Error");
                        $('#loader').hide();
                    },
                    success: function (obj) {
                        //******************************
                        if (obj.SaveActivateERTResult == true) {
                            //*************************
                            var Message = window.localStorage["ContactName"] + ' has activated ERP for ' + $("#ddlHazard option:selected").text();
                            //*************************
                            $("#ddlHazard").val('-1');
                            $("#txtCommentERP").val('');
                            //*************************
                            SendMessageGCMMobile(window.localStorage["IdCompany"], $("#hdnIdSite").val(), Message, 'ERT', window.localStorage["Code"]);
                            //*************************
                            //alert('ERP has been activated')
                            navigator.notification.alert("ERP has been activated", function () { }, "BCP Alert");
                            //*************************
                            var IdSite = $("#hdnIdSite").val();
                            var Site = $("#hdnSite").val();
                            var Latitude = $("#hdnLatitude").val();
                            var Longitude = $("#hdnLongitude").val();
                            var KeyBCP = $("#hdnKeywordERT").val();
                            //*************************
                            window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                            //*************************
                        } else {
                            alert('fail')
                        }
                        //******************************
                    },
                    complete: function () {
                        $('#loader').hide();
                    }
                });
                //***************************************
            }

        });
        //***************************************
        var wcfServiceUrl = "http://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
        urlk1 = wcfServiceUrl + "ListHazard?IdCompany=" + IdCompany + '&IdSite=' + IdSite + '&IdEvent=' + IdEvent + '&Code=' + Code;
        //***************************************
        $.ajax({
            //cache: true,
            url: urlk1,
            crossDomain: true,
            data: "{ IdCompany: " + IdCompany + ", IdSite: " + IdSite + ", IdEvent: '" + IdEvent + "', Code: '" + Code + "' }",
            type: "GET",
            jsonpCallback: "lsobjHazard",
            contentType: "application/json; charset=utf-8",
            dataType: "jsonp",
            beforeSend: function () {
                $('#loader').show();
            },
            error: function (xhr, textStatus, err) {
                var mensaje = "readyState: " + xhr.readyState + "\n";
                mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                mensaje = mensaje + "status: " + xhr.status + "\n";
                mensaje = mensaje + "text status: " + textStatus + "\n";
                mensaje = mensaje + "error: " + err + "\n";
                navigator.notification.alert(mensaje, function () { }, "BCP Error");
                $('#ddlHazard').html("");
                $('#loader').hide();
            },
            success: function (obj) {
                //******************************
                $('#ddlHazard').html("");
                //******************************
                if (obj.ListHazardResult.length > 0) {
                    //******************************
                    $("#hdnRequiredKey").val(obj.ListHazardResult[0].RequiredKey);
                    //******************************
                } else {
                    //******************************
                    $("#ddlHazard")
                        .append($("<option selected='selected'></option>")
                        .val('-1')
                        .html('Select')
                        .text('Select')
                        .attr("title", 'Select'));
                    //******************************
                }
                //******************************
                $.each(obj.ListHazardResult, populateDropdown);
                //******************************
                $("#ddlHazard").selectmenu('refresh', true);
                //******************************
                $("#ddlHazard option:eq(0)").attr("selected", "selected");
                //******************************
                $("#ddlHazard").trigger("change");
                //******************************
            },
            complete: function () {
                $('#loader').hide();
            }
        });
        //***************************************
    });
        //***************************************
    </script>

</head>
<body>
    <div data-role="page" id="map-page" data-url="map-page">
        <div data-role="header" data-position="fixed" style="background-color:#0065B3;color:white;font-size:11px;font-weight:normal;">
            <a href="#" id="btnHome" class="ui-btn ui-shadow ui-corner-all ui-icon-carat-l ui-btn-icon-notext" style="background-color:#0065B3;position:-ms-page;top: 12px !important;" data-role="button" role="button"></a>
            <a href="#" id="btnUp" class="ui-btn ui-corner-all ui-shadow ui-btn-icon-left ui-btn-icon-notext">V</a>
            <h1 id="span1"></h1>
            <div id="DivHeader" data-role="collapsible-set" style="display:none;">
                <table style="color:#0065B3;">
                    <tr>
                        <td>
                            <div data-role="fieldcontain">
                                <label for="txtkeywordERT" class="select"></label>
                                <input type="text" id="txtkeywordERT" placeholder="keyword ERT">
                            </div>
                        </td>
                        <td>
                            <div data-role="fieldcontain">
                                <label for="ddlHazard" class="select"></label>
                                <select id="ddlHazard" placeholder="Select Hazard"></select>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div data-role="fieldcontain">
                                <label for="txtCommentERP" class="select"></label>
                                <textarea id="txtCommentERP" placeholder="Comments ERT"></textarea>
                            </div>
                        </td>
                        <td>
                            <input type="button" id="btnSubmitERP" data-icon="star" data-theme="a" data-form="ui-btn-up-a" value="Activate ERP" />
                        </td>
                    </tr>
                </table>
            </div>
            <div id="loader" style="display:none;">
                <div id="center">
                    <img src="images/ajax-loader.gif" />
                </div>
            </div>
        </div>
        <div style="display:none;">
            <p id="geolocation"></p>
        </div>
        <div role="main" class="ui-content" id="map-canvas">
            <!-- map loads here... -->
        </div>
        <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
            ©BCP Insight Risk Technologies, LLC <span class="jqm-version"></span>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript" src="js/PushNotification.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
    </div>
    <input type="hidden" id="hdnIdAlert" />
    <input type="hidden" id="hdnIdSite" />
    <input type="hidden" id="hdnSite" />
    <input type="hidden" id="hdnLatitude" />
    <input type="hidden" id="hdnLongitude" />
    <input type="hidden" id="hdnLatitudeERT" />
    <input type="hidden" id="hdnLongitudeERT" />
    <input type="hidden" id="hdnKeywordERT" />
    <input type="hidden" id="hdnRequiredKey" />
</body>
</html>