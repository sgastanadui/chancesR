<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sites</title>
    <!-- InsightBCPMobile references -->
    <link href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/common.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript">
        //***************************************
        var geocoder;
        var map;
        var infowindow = new google.maps.InfoWindow();
        //***************************************
        var registrandoPosicion = false,
        idRegistroPosicion,
        ultimaPosicionUsuario,
        marcadorUsuario,
        div = document.getElementById('map-canvas');
        //***************************************
        function drawMap(latlng) {
            var myOptions = {
                zoom: 25,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                backgroundColor: '#ffffff',
                noClear: true,
                disableDefaultUI: false,
                keyboardShortcuts: true,
                disableDoubleClickZoom: false,
                draggable: true,
                scrollwheel: true,
                draggableCursor: 'pointer',
                draggingCursor: 'crosshair',
                mapTypeControl: true,
                panControl: true,
                panControlOptions: {
                    position: google.maps.ControlPosition.TOP_RIGHT
                },
                navigationControl: true,
                streetViewControl: true,
                streetViewControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_TOP
                },
                navigationControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_TOP,
                    style: google.maps.NavigationControlStyle.ANDROID
                },
                scaleControl: true,
                scaleControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_TOP,
                    style: google.maps.ScaleControlStyle.DEFAULT
                },
                zoomControl: true,
                zoomControlOptions: {
                    //style: google.maps.ZoomControlStyle.LARGE,
                    position: google.maps.ControlPosition.RIGHT_TOP
                }
            };

            map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

            var input = document.getElementById('geolocation').innerHTML;
            var latlngStr = input.split(',', 2);
            var lat = parseFloat(latlngStr[0]);
            var lng = parseFloat(latlngStr[1]);
            var latlng = new google.maps.LatLng(lat, lng);
            geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        //map.setZoom(17);
                        infowindow.setContent(results[1].formatted_address);
                        infowindow.open(map, marcadorUsuario);
                    }
                    else {
                        navigator.notification.alert('No ha encontrado resultados');
                    }
                }
                else {
                    navigator.notification.alert('Ningún resultado encontrado: ' + status);
                }
            });
        }
        //***************************************
        function codeLatLng() {
            var input = document.getElementById('geolocation').innerHTML;
            var latlngStr = input.split(',', 2);
            var lat = parseFloat(latlngStr[0]);
            var lng = parseFloat(latlngStr[1]);
            var latlng = new google.maps.LatLng(lat, lng);
            geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        //map.setZoom(17);
                        infowindow.setContent(results[1].formatted_address);
                        infowindow.open(map, marcadorUsuario);
                        //registrarPosicion();
                    }
                    else {
                        navigator.notification.alert('No ha encontrado resultados');
                    }
                }
                else {
                    navigator.notification.alert('Ningún resultado encontrado: ' + status);
                }
            });
        }
        //***************************************
        function registrarPosicion() {
            if (registrandoPosicion) {
                registrandoPosicion = false;
                navigator.geolocation.clearWatch(idRegistroPosicion);
                limpiarUbicacion();
            }
            else {
                //idRegistroPosicion = navigator.geolocation.getCurrentPosition(
                //    exitoRegistroPosicion,
                //    falloRegistroPosicion,
                //    {
                //        maximumAge: 500000,
                //        enableHighAccuracy: true,
                //        timeout: 6000
                //    });
                idRegistroPosicion = navigator.geolocation.watchPosition(
                    exitoRegistroPosicion,
                    falloRegistroPosicion,
                    {
                        enableHighAccuracy: true,
                        maximumAge: 60000, //Milisegundos
                        timeout: 6000 //Milisegundos
                    }
                );
            }
        }
        //***************************************
        function exitoRegistroPosicion(position) {
            if (!registrandoPosicion) {
                registrandoPosicion = true;
                ultimaPosicionUsuario = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                marcadorUsuario = new google.maps.Marker({
                    position: ultimaPosicionUsuario,
                    map: map
                });
            }
            else {
                var posicionActual = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                if (google.maps.geometry.spherical.computeDistanceBetween(posicionActual, ultimaPosicionUsuario) > 2) {//Metros de distancia entre la ultima posicion y la posicion actual
                    ultimaPosicionUsuario = posicionActual;
                    marcadorUsuario.setPosition(posicionActual);
                }
            }
            var IdCompany = window.localStorage["IdCompany"];
            var IdAlert = $("#hdnIdAlert").val();
            var IdContact = $("#hdnIdContact").val();
            var IdHazard = $("#hdnIdHazard").val();
            var IdSite = $("#hdnIdSite").val();
            //alert(IdCompany + ' , ' + IdAlert + ' , ' + IdContact + ' , ' + IdHazard + ' , ' + IdSite);
            //alert(position.coords.latitude + ' , ' + position.coords.longitude);
            RegistrarHistoryCurrentLocationUser(IdCompany, IdAlert, IdSite, IdHazard, IdContact, position.coords.latitude, position.coords.longitude);
            map.panTo(ultimaPosicionUsuario);
        }
        //***************************************
        function falloRegistroPosicion() {
            navigator.notification.alert('No se pudo determinar la ubicación');
            limpiarUbicacion();
        }
        //***************************************
        function limpiarUbicacion() {
            ultimaPosicionUsuario = new google.maps.LatLng(0, 0);
            if (marcadorUsuario) {
                marcadorUsuario.setMap(null);
                marcadorUsuario = null;
            }
        }
        //***************************************
        function RegistrarHistoryCurrentLocationUser(IdCompany, IdAlert, IdSite, IdHazard, IdContact, Latitude, Longitude) {
            try {
                //************************************************
                var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
                //************************************************
                var urlk1 = wcfServiceUrl + "SaveHistoryLocationUser?IdAlert=" + IdAlert + '&IdCompany=' + IdCompany + '&IdContact=' + IdContact + '&IdLocation=' + IdSite + '&IdHazard=' + IdHazard + '&Latitude=' + Latitude + '&Longitude=' + Longitude;
                //************************************************
                $.ajax({
                    cache: true,
                    async: true,
                    url: urlk1,
                    crossDomain: true,
                    data: "{ IdAlert: " + IdAlert + ", IdCompany: " + IdCompany + ", IdContact: " + IdContact + ", IdLocation:" + IdSite + ", Latitude: '" + Latitude + "', Longitude: '" + Longitude + "' }",
                    type: "GET",
                    jsonpCallback: "HistoryUser",
                    contentType: "application/json; charset=utf-8",
                    dataType: "jsonp",
                    beforeSend: function () {
                        //$('#loader').show();
                    },
                    error: function (xhr, textStatus, err) {
                        var mensaje = "readyState: " + xhr.readyState + "\n";
                        mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                        mensaje = mensaje + "status: " + xhr.status + "\n";
                        mensaje = mensaje + "text status: " + textStatus + "\n";
                        mensaje = mensaje + "error: " + err + "\n";
                        navigator.notification.alert(mensaje, function () { }, "BCP Error");
                        //$('#loader').hide();
                    },
                    success: function (objHistory) {
                        //******************************
                        if (objHistory.SaveHistoryLocationUserResult > 0) {
                            //navigator.notification.alert('Sucessful saved.');
                        }
                        //******************************
                    },
                    complete: function () {
                        //$('#loader').hide();
                    }
                });
                //***************************************
            } catch (ex) {
                alert(ex.message);
            }
        }
        //***************************************
        $(document).on("pagecreate", "#map-page", function () {
            //*********************************
            var longitude = -0.583331;
            var latitude = 38.96130;
            //*********************************
            geocoder = new google.maps.Geocoder();
            var defaultLatLng = new google.maps.LatLng(latitude, longitude);  // Default to Hollywood, CA when no geolocation support
            //*********************************
            if (navigator.geolocation) {
                //***************************************
                function success(pos) {
                    // Location found, show map with these coordinates
                    var element = document.getElementById('geolocation');
                    element.innerHTML = pos.coords.latitude + ',' + pos.coords.longitude;
                    drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                }
                //***************************************
                function fail(error) {
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            navigator.notification.alert("User denied the request for Geolocation.", function () { }, "BCP Error");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            navigator.notification.alert("Location information is unavailable.", function () { }, "BCP Error");
                            break;
                        case error.TIMEOUT:
                            navigator.notification.alert("The request to get user location timed out.", function () { }, "BCP Error");
                            break;
                        case error.UNKNOWN_ERROR:
                            navigator.notification.alert("An unknown error occurred.", function () { }, "BCP Error");
                            break;
                    }
                    drawMap(defaultLatLng);  // Failed to find location, show default map
                }
                //***************************************
                // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
                navigator.geolocation.getCurrentPosition(success, fail, { maximumAge: 500000, enableHighAccuracy: true, timeout: 6000 });
                //***************************************
            } else {
                drawMap(defaultLatLng);  // No geolocation support, show default map
            }
            setInterval(codeLatLng, 30000);
        });
        //***************************************
        $(document).on("pageinit", "#map-page", function (event) {
        //***************************************
            var IdCompany = getUrlVars()["IdCompany"];
            var IdHazard = getUrlVars()["IdHazard"];
            var IdContact = getUrlVars()["IdContact"];
            var IdSite = getUrlVars()["IdSite"];
            var IdAlert = getUrlVars()["IdAlert"];
            //***************************************
            $("#hdnIdAlert").val(IdAlert);
            $("#hdnIdSite").val(IdSite);
            $("#hdnIdHazard").val(IdHazard);
            $("#hdnIdContact").val(IdContact);
            //***************************************
            var CompanyName = window.localStorage["CompanyName"];
            $("#span1").html("" + CompanyName + "");
            //***************************************
            $("#btnHome").off("click");
            $("#btnHome").click(function () {
                //************************************************
                var IdSite = $("#hdnIdSite").val();
                var Latitude = $("#hdnLatitude").val();
                var Longitude = $("#hdnLongitude").val();
                var Site = $("#hdnSite").val();
                var KeyBCP = $("#hdnKeywordERT").val();
                window.location.href = 'home.html?IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                //************************************************
            });
            //***************************************
        });
        //***************************************
    </script>

</head>
<body>
    <div data-role="page" id="map-page" data-url="map-page">
        <div data-role="header" data-position="fixed" style="background-color:#0065B3;color:white;font-size:11px;font-weight:normal;">
            <a href="#" id="btnHome" class="ui-btn ui-shadow ui-corner-all ui-icon-carat-l ui-btn-icon-notext" style="background-color:#0065B3;position:-ms-page;top: 12px !important;" data-role="button" role="button"></a>
            <h1 id="span1"></h1>
            <div id="loader" style="display:none;">
                <div id="center">
                    <img src="images/ajax-loader.gif" />
                </div>
            </div>
        </div>
        <input type="button" value="Actualizar posición" onclick="registrarPosicion()">
        <div style="display:none;">
            <p id="geolocation"></p>
        </div>
        <div role="main" class="ui-content" id="map-canvas">
            <!-- map loads here... -->
        </div>
        <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
            ©BCP Insight Risk Technologies, LLC <span class="jqm-version"></span>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript" src="js/PushNotification.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
    </div>
    <input type="hidden" id="hdnIdAlert" />
    <input type="hidden" id="hdnIdSite" />
    <input type="hidden" id="hdnIdContact" />
    <input type="hidden" id="hdnIdHazard" />
    <input type="hidden" id="hdnLatitude" />
    <input type="hidden" id="hdnLongitude" />
</body>
</html>