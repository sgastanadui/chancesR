<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--<meta http-equiv="refresh" content="10" />-->
    <title></title>
    <!--<style type="text/css">
        html, body, #map_canvas {
            margin: 0;
            padding: 0;
            height: 100%;
        }
    </style>-->
    <link href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/common.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript">

        function initialize() {
            //*********************************
            var IdCompany = getUrlVars()["IdCompany"];
            var IdSite = getUrlVars()["IdSite"];
            var IdHazard = getUrlVars()["IdHazard"];
            var IdContact = getUrlVars()["IdContact"];
            var IdAlert = getUrlVars()["IdAlert"];
            var pathFutureCoordinates = new Array();
            var Latitude, Longitude; 
            //*********************************
            // Enable background mode
            //cordova.plugins.backgroundMode.enable();

            //cordova.plugins.backgroundMode.onactivate = function () {
            //    setTimeout(function () {
            //        // Modify the currently displayed notification
            //        cordova.plugins.backgroundMode.configure({
            //            text: 'Running in background for more than 5s now.'
            //        });
            //    }, 5000);
            //}

            //alert(IdCompany + ' ' + IdSite + ' ' + IdHazard + ' ' + IdContact + ' ' + IdAlert);

            //************************************************************
            var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
            var urlk1 = wcfServiceUrl + "ListHistoryGPSUser?IdCompany=" + IdCompany + "&IdSite=" + IdSite + "&IdHazard=" + IdHazard + "&IdContact=" + IdContact + "&IdAlert=" + IdAlert;
            //************************************************************
            $.ajax({
                //cache: true,
                async: false,
                url: urlk1,
                crossDomain: true,
                data: "{ IdCompany: " + IdCompany + " }",
                type: "GET",
                jsonpCallback: "lsobjHistoryGPS",
                contentType: "application/json; charset=utf-8",
                dataType: "jsonp",
                beforeSend: function () {
                    $('#loader').show();
                },
                error: function (xhr, textStatus, err) {
                    var mensaje = "readyState: " + xhr.readyState + "\n";
                    mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                    mensaje = mensaje + "status: " + xhr.status + "\n";
                    mensaje = mensaje + "text status: " + textStatus + "\n";
                    mensaje = mensaje + "error: " + err + "\n";
                    navigator.notification.alert(mensaje, function () { }, "BCP Error");
                    $('#loader').hide();
                },
                success: function (obj) {
                    //******************************
                    for (var i = 0; i < obj.ListHistoryGPSUserResult.length; i++) {
                        pathFutureCoordinates.push(new google.maps.LatLng(obj.ListHistoryGPSUserResult[i].Latitude, obj.ListHistoryGPSUserResult[i].Longitude));
                    }
                    if (obj.ListHistoryGPSUserResult.length > 0) {
                        Latitude = obj.ListHistoryGPSUserResult[0].Latitude;
                        Longitude = obj.ListHistoryGPSUserResult[0].Longitude;
                    }
                    //***************************************
                    var mapOptions = {
                        center: new google.maps.LatLng(Latitude, Longitude),
                        zoom: 15,
                        mapTypeId: google.maps.MapTypeId.ROADMAP,
                        backgroundColor: '#ffffff',
                        noClear: true,
                        disableDefaultUI: false,
                        keyboardShortcuts: true,
                        disableDoubleClickZoom: false,
                        draggable: true,
                        scrollwheel: true,
                        draggableCursor: 'pointer',
                        draggingCursor: 'crosshair',
                        mapTypeControl: true,
                        panControl: true,
                        panControlOptions: {
                            position: google.maps.ControlPosition.TOP_RIGHT
                        },
                        navigationControl: true,
                        streetViewControl: true,
                        streetViewControlOptions: {
                            position: google.maps.ControlPosition.RIGHT_TOP
                        },
                        navigationControlOptions: {
                            position: google.maps.ControlPosition.TOP_LEFT,
                            style: google.maps.NavigationControlStyle.ANDROID
                        },
                        scaleControl: true,
                        zoomControlOptions: {
                            //style: google.maps.ZoomControlStyle.LARGE,
                            position: google.maps.ControlPosition.RIGHT_TOP
                        }
                    };
                    //***************************************
                    var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
                    //***************************************
                    for (var i = 0; i < pathFutureCoordinates.length; i++) {
                        new google.maps.Marker({
                            map: map,
                            position: pathFutureCoordinates[i],
                            icon: "images/geolocation_marker.png"
                        });
                    }
                    //***************************************
                    var simboloFlecha = {
                        strokeColor: '#000',
                        scale: 3,
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
                    };
                    //***************************************
                    var polyFutureOptions = {
                        path: pathFutureCoordinates,
                        icons: [{
                            icon: simboloFlecha
                        }],
                        geodesic: true,
                        strokeColor: '#0000FF',
                        strokeOpacity: 0.8,
                        strokeWeight: 2.5
                    };
                    //***************************************
                    var pathFuture = new google.maps.Polyline(polyFutureOptions);
                    pathFuture.setMap(map);
                    //***************************************                  
                    animateCircle(pathFuture);
                    //***************************************                  
                },
                complete: function () {
                    $('#loader').hide();
                }
            });

        }
        //***************************************
        // Use the DOM setInterval() function to change the offset of the symbol
        // at fixed intervals.
        function animateCircle(line) {
            var count = 0;
            window.setInterval(function () {
                count = (count + 1) % 200;

                var icons = line.get('icons');
                icons[0].offset = (count / 2) + '%';
                line.set('icons', icons);
            }, 20);
        }
        //***************************************
        google.maps.event.addDomListener(window, 'load', initialize);
        //***************************************
        $(document).on("pageinit", "#map-page", function (event) {
            //***************************************
            var IdAlertsERT = getUrlVars()["IdAlert"];
            var IdCompany = getUrlVars()["IdCompany"];
            var IdSite = getUrlVars()["IdSite"];
            var Site = getUrlVars()["Site"];
            var KeyBCP = getUrlVars()["KeyBCP"];
            var Latitude = '';
            var Longitude = '';
            //***************************************
            $("#hdnIdAlertsERT").val(IdAlertsERT);
            $("#hdnIdSite").val(IdSite);
            $("#hdnKeyword").val(KeyBCP);
            $("#hdnSite").val(unescape(Site));
            $("#hdnLatitude").val(Latitude);
            $("#hdnLongitude").val(Longitude);
            //***************************************
            var CompanyName = window.localStorage["CompanyName"];
            $("#span1").html("" + CompanyName + " <br/>" + unescape(Site));
            //***************************************
            $("#btnHome").off("click");
            $("#btnHome").click(function () {
                //************************************************
                var IdCompany = window.localStorage["IdCompany"];
                var IdSite = $("#hdnIdSite").val();
                var Site = $("#hdnSite").val();
                var KeyBCP = $("#hdnKeyword").val();
                var Latitude = $("#hdnLatitude").val();
                var Longitude = $("#hdnLongitude").val();
                window.location.href = 'home.html?IdCompany=' + IdCompany + '&IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                //************************************************
            });
            //***************************************
            $("#btnRefresh").off("click");
            $("#btnRefresh").click(function () {
                //************************************************
                var IdCompany = window.localStorage["IdCompany"];
                var IdSite = $("#hdnIdSite").val();
                var Site = $("#hdnSite").val();
                var KeyBCP = $("#hdnKeyword").val();
                var Latitude = $("#hdnLatitude").val();
                var Longitude = $("#hdnLongitude").val();
                var IdHazard = getUrlVars()["IdHazard"];
                var IdContact = getUrlVars()["IdContact"];
                var IdAlert = getUrlVars()["IdAlert"];
                //window.location.href = 'home.html?IdCompany=' + IdCompany + '&IdSite=' + IdSite + '&Latitude=' + Latitude + '&Longitude=' + Longitude + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                window.location.href = 'geo.html?IdAlert=' + IdAlert + '&IdCompany=' + IdCompany + '&IdSite=' + IdSite + '&IdHazard=' + IdHazard + '&IdContact=' + IdContact + '&Site=' + escape(Site) + '&KeyBCP=' + KeyBCP;
                //************************************************
            });
            //***************************************
        });
        //***************************************
    </script>
</head>
<body>
    <div data-role="page" id="map-page" data-url="map-page">
        <div data-role="header" data-position="fixed" style="background-color:#0065B3;color:white;font-size:11px;font-weight:normal;">
            <h1 id="span1"></h1>
            <a href="#" id="btnHome" class="ui-btn ui-shadow ui-corner-all ui-icon-carat-l ui-btn-icon-notext" style="background-color:#0065B3;position:-ms-page;top: 12px !important;" data-role="button" role="button"></a>
            <a href="#" id="btnRefresh" class="ui-btn ui-icon-navigation ui-btn-icon-left" style="background-color:#0065B3;position:-ms-page;top: 17px !important;" data-role="button" role="button"></a>
        </div>
        <div role="main" class="ui-content" id="map-canvas">
            <!-- map loads here... -->
        </div>
        <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
            ©BCP Insight Risk Technologies,LLC <span class="jqm-version"></span>
        </div>
        <!-- Div Loading -->
        <div id="loader" style="display:none;">
            <div id="center">
                <img src="images/ajax-loader.gif" />
            </div>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
        <input type="hidden" id="hdnIdAlertsERT" />
        <input type="hidden" id="hdnIdSite" />
        <input type="hidden" id="hdnSite" />
        <input type="hidden" id="hdnKeyword" />
        <input type="hidden" id="hdnLatitude" />
        <input type="hidden" id="hdnLongitude" />
    </div>
</body>
</html>