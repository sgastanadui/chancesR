<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link type="text/css" href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link type="text/css" href="css/index.css" rel="stylesheet" />
    <script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript">

        // Load Event Handler
        window.onload = function () {
            //*********************************
            var IdAlert = getUrlVars()["IdAlert"];
            var IdSite = getUrlVars()["IdSite"];
            var IdCompany = getUrlVars()["IdCompany"];
            var IdHazard = getUrlVars()["IdHazard"];
            var IdContact = getUrlVars()["IdContact"];
            ////*********************************
            $("#hdnIdCompany").val(IdCompany);
            $("#hdnIdAlert").val(IdAlert);
            $("#hdnIdSite").val(IdSite);
            $("#hdnIdContact").val(IdContact);
            $("#hdnIdHazard").val(IdHazard);
            //alert(IdAlert + ' ' + IdSite + ' ' + IdCompany + ' ' + IdHazard + ' ' + IdContact)
            //*********************************
            getLocation();
            setInterval(getLocation, 15000);
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(handleSuccess, handleError, { maximumAge: 50000, enableHighAccuracy: true, timeout: 6000 });
      }

      function initiate_watchlocation() {
        if(watchProcess == null){
            watchProcess = navigator.geolocation.watchPosition(handleSuccess, handleError, { maximumAge: 50000, enableHighAccuracy: true, timeout: 6000 });
        }
      }

      function stop_watchlocation() {
        if(watchProcess != null){
          navigator.geolocation.clearWatch(watchProcess);
        }
      }

      function handleSuccess(position) {
          //************************************************
          drawMap(position);
          //************************************************
          var IdCompany = $("#hdnIdCompany").val();
          var IdAlert = $("#hdnIdAlert").val();
          var IdSite = $("#hdnIdSite").val();
          var IdContact = $("#hdnIdContact").val();
          var IdHazard = $("#hdnIdHazard").val();
          //************************************************
          var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
          //************************************************
          var urlk1 = wcfServiceUrl + "SaveHistoryLocationUser?IdAlert=" + IdAlert + '&IdCompany=' + IdCompany + '&IdContact=' + IdContact + '&IdLocation=' + IdSite + '&IdHazard=' + IdHazard + '&Latitude=' + position.coords.latitude + '&Longitude=' + position.coords.longitude;
          //************************************************
          $.ajax({
              //cache: true,
              async: true,
              url: urlk1,
              crossDomain: true,
              data: "{ IdAlert: " + IdAlert + ", IdCompany: " + IdCompany + ", IdContact: " + IdContact + ", IdLocation:" + IdSite + ", Latitude: '" + position.coords.latitude + "', Longitude: '" + position.coords.longitude + "' }",
              type: "GET",
              jsonpCallback: "HistoryUser",
              contentType: "application/json; charset=utf-8",
              dataType: "jsonp",
              beforeSend: function () {
                  //$('#loader').show();
              },
              error: function (xhr, textStatus, err) {
                  var mensaje = "readyState: " + xhr.readyState + "\n";
                  mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                  mensaje = mensaje + "status: " + xhr.status + "\n";
                  mensaje = mensaje + "text status: " + textStatus + "\n";
                  mensaje = mensaje + "error: " + err + "\n";
                  //navigator.notification.alert(mensaje, function () { }, "BCP Error");
                  //$('#loader').hide();
              },
              success: function (objHistory) {
                  //******************************
                  if (objHistory.SaveHistoryLocationUserResult > 0) {
                      //navigator.notification.alert('Sucessful saved.');
                  }
                  //******************************
              },
              complete: function () {
                  //$('#loader').hide();
              }
          });
          //***************************************
      }

      function handleError(error){
        switch(error.code)
        {
          case error.PERMISSION_DENIED: alert("User did not share geolocation data");break;
          case error.POSITION_UNAVAILABLE: alert("Could not detect current position");break;
          case error.TIMEOUT: alert("Retrieving position timed out");break;
          default: alert("Unknown Error");break;
        }
      }


      function drawMap(position) {
        var container = $('#map_canvas');
        var myLatLong = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
        var mapOptions = {
            center: myLatLong,
            zoom: 18,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            backgroundColor: '#ffffff',
            noClear: true,
            disableDefaultUI: false,
            keyboardShortcuts: true,
            disableDoubleClickZoom: false,
            draggable: true,
            scrollwheel: true,
            draggableCursor: 'pointer',
            draggingCursor: 'crosshair',
            mapTypeControl: true,
            panControl: true,
            panControlOptions: {
                position: google.maps.ControlPosition.TOP_RIGHT
            },
            navigationControl: true,
            streetViewControl: true,
            streetViewControlOptions: {
                position: google.maps.ControlPosition.RIGHT_TOP
            },
            navigationControlOptions: {
                position: google.maps.ControlPosition.RIGHT_TOP,
                style: google.maps.NavigationControlStyle.ANDROID
            },
            scaleControl: true,
            scaleControlOptions: {
                position: google.maps.ControlPosition.RIGHT_TOP,
                style: google.maps.ScaleControlStyle.DEFAULT
            },
            zoomControl: true,
            zoomControlOptions: {
                //style: google.maps.ZoomControlStyle.LARGE,
                position: google.maps.ControlPosition.RIGHT_TOP
            }
        };
        var map = new google.maps.Map(container[0],mapOptions);
        container.css('display','block');
        var marker = new google.maps.Marker({
          position: myLatLong,
          map:map,
          title:"My Position (Accuracy of Position: " + position.coords.accuracy + " Meters), Altitude: "
            + position.coords.altitude + ' Altitude Accuracy: ' + position.coords.altitudeAccuracy
        });

      }

      function drawStaticMap(position){
        var container = $('#map_canvas');
        var imageUrl = "http://maps.google.com/maps/api/staticmap?sensor=false&center=" + position.coords.latitude + "," +
                    position.coords.longitude + "&zoom=18&size=640x500&markers=color:blue|label:S|" +
                    position.coords.latitude + ',' + position.coords.longitude;

        container.css({
          'display':'block',
          'width' : 640
        });
        $('<img/>',{
          src : imageUrl
        }).appendTo(container);
      }


    </script>
    <style type="text/css">
        html { height: 100% }
      
        body { }
      
        #map_canvas { 
            height: 300px;
            width: 100%;
            display: none;
        }
     
      #getLocation{
          box-shadow: 0 0 4px rgba(0, 0, 0, 0.29);
          display: block;
          margin: 1em auto;
          padding: 5px;
      }

      #map_canvas > div > div:nth-child(3){
        display: none;
      }
    </style>
</head>
<body>
    <div data-role="page" id="map-page-geolocator">
        <div role="main" class="ui-content" id="map_canvas">

        </div>
        <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
            ©BCP Insight Risk Technologies,LLC <span class="jqm-version"></span>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
        <input type="hidden" id="hdnIdCompany" />
        <input type="hidden" id="hdnIdAlert" />
        <input type="hidden" id="hdnIdSite" />
        <input type="hidden" id="hdnIdContact" />
        <input type="hidden" id="hdnIdHazard" />
    </div>
</body>
</html>
