<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title></title>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"> </script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/PushNotification.js"></script>
    <script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <link href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />
    <script type="text/javascript">
        var map;
        //***************************************
        $(document).on("pagecreate", "#map-track", function () {
            //***************************************

            //***************************************
        })
        //***************************************
        $(document).on("pageinit", "#map-track", function (event) {
            //***************************************
            var _IdRoute = '1';//getUrlVars()["id"];
            var _Username = 'RN-1214-A';//getUrlVars()["usr"];
            var _Password = '1526093542';//getUrlVars()["pwd"];
            ////*********************************
            $("#hdnIdRoute").val(_IdRoute);
            $("#hdnUsername").val(_Username);
            $("#hdnPassword").val(_Password);
            //************************************************
            var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightTRACK.svc/";
            var urlk1 = wcfServiceUrl + "SearchRoute?IdRoute=" + _IdRoute + '&Username=' + _Username + '&PasswordUser=' + _Password;
            //************************************************
            $.ajax({
                cache: true,
                url: urlk1,
                crossDomain: true,
                data: "{ IdRoute: " + _IdRoute + ", Username: '" + _Username + "', PasswordUser: '" + _Password + "' }",
                type: "GET",
                jsonpCallback: "SearchRoute",
                contentType: "application/json; charset=utf-8",
                dataType: "jsonp",
                beforeSend: function () {
                    $('#loader').show();
                },
                error: function (xhr, textStatus, err) {
                    var mensaje = "readyState: " + xhr.readyState + "\n";
                    mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                    mensaje = mensaje + "status: " + xhr.status + "\n";
                    mensaje = mensaje + "text status: " + textStatus + "\n";
                    mensaje = mensaje + "error: " + err + "\n";
                    navigator.notification.alert(mensaje, function () { }, "BCP Error");
                    $('#loader').hide();
                },
                success: function (obj) {
                   //*********************************
                    var directionsService = new google.maps.DirectionsService;
                    var directionsDisplay = new google.maps.DirectionsRenderer;
                   
                    map = new google.maps.Map(document.getElementById('map-canvas'), {
                        zoom: 14,
                        center: { lat: 41.85, lng: -87.65 },
                        mapTypeId: google.maps.MapTypeId.ROADMAP,
                        backgroundColor: '#ffffff',
                        noClear: true,
                        disableDefaultUI: false,
                        keyboardShortcuts: true,
                        disableDoubleClickZoom: false,
                        draggable: true,
                        scrollwheel: true,
                        draggableCursor: 'pointer',
                        draggingCursor: 'crosshair',
                        mapTypeControl: true,
                        panControl: true,
                        panControlOptions: {
                            position: google.maps.ControlPosition.TOP_RIGHT
                        },
                        navigationControl: true,
                        streetViewControl: true,
                        streetViewControlOptions: {
                            position: google.maps.ControlPosition.RIGHT_TOP
                        },
                        navigationControlOptions: {
                            position: google.maps.ControlPosition.RIGHT_TOP,
                            style: google.maps.NavigationControlStyle.ANDROID
                        },
                        scaleControl: true,
                        scaleControlOptions: {
                            position: google.maps.ControlPosition.RIGHT_TOP,
                            style: google.maps.ScaleControlStyle.DEFAULT
                        },
                        zoomControl: true,
                        zoomControlOptions: {
                            //style: google.maps.ZoomControlStyle.LARGE,
                            position: google.maps.ControlPosition.RIGHT_TOP
                        }
                                                  
                    });
                    directionsDisplay.setMap(map);
                    directionsDisplay.setPanel(document.getElementById('right-panel'));
                    //*********************************
                    calculateAndDisplayRoute(directionsService, directionsDisplay, obj.SearchRouteResult.PickupAddress, obj.SearchRouteResult.DeliveryAddress);
                    //*********************************
                    navigator.geolocation.getCurrentPosition(success, fail, { maximumAge: 5000, enableHighAccuracy: true, timeout: 2000 });
                   //*********************************
                },
                complete: function () {
                    $('#loader').hide();
                }
            });
            //***************************************
        });
        //***************************************
        function updateStatus(nameStatus){
            try{
                //************************************************
                var _IdRoute = $("#hdnIdRoute").val();
                var _Username = $("#hdnUsername").val();
                //************************************************
                var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightTRACK.svc/";
                var urlk1 = wcfServiceUrl + "SaveStatusTracking?IdRoute=" + _IdRoute + '&Username=' + _Username + '&Status=' + nameStatus;
                //************************************************
                $.ajax({
                       cache: true,
                       url: urlk1,
                       crossDomain: true,
                       data: "{ IdRoute: " + _IdRoute + ", Username: '" + _Username + "', Status: '"+ nameStatus +"' }",
                       type: "GET",
                       jsonpCallback: "SearchRoute",
                       contentType: "application/json; charset=utf-8",
                       dataType: "jsonp",
                       beforeSend: function () {
                            $('#loader').show();
                       },
                       error: function (xhr, textStatus, err) {
                            var mensaje = "readyState: " + xhr.readyState + "\n";
                            mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                            mensaje = mensaje + "status: " + xhr.status + "\n";
                            mensaje = mensaje + "text status: " + textStatus + "\n";
                            mensaje = mensaje + "error: " + err + "\n";
                            navigator.notification.alert(mensaje, function () { }, "TRACK Error");
                            $('#loader').hide();
                       },
                       success: function (obj) {
                       //*********************************
                           if (obj.SaveStatusTrackingResult > 0){
                                navigator.notification.alert('sucessfull ' + nameStatus, function () { }, "Notification TRACK");
                           }
                       //*********************************
                       },
                       complete: function () {
                            $('#loader').hide();
                       }
                });
                //************************************************
                
            }catch(ex){
                navigator.notification.alert(ex.message, function () { }, "TRACK Error");
            }
        }
        //***************************************
        function success(pos) {
             drawMap(pos);
        }
        //***************************************
        function fail(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    navigator.notification.alert("User denied the request for Geolocation.", function () { }, "BCP Error");
                    break;
                case error.POSITION_UNAVAILABLE:
                    navigator.notification.alert("Location information is unavailable.", function () { }, "BCP Error");
                    break;
                case error.TIMEOUT:
                    navigator.notification.alert("The request to get user location timed out.", function () { }, "BCP Error");
                    break;
                case error.UNKNOWN_ERROR:
                    navigator.notification.alert("An unknown error occurred.", function () { }, "BCP Error");
                    break;
            }
        }
        //***************************************
        function calculateAndDisplayRoute(directionsService, directionsDisplay, origen, destino) {
            directionsService.route({
                origin: origen,
                destination: destino,
                travelMode: google.maps.TravelMode.DRIVING
            }, function (response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }
        //***************************************
        function drawMap(latlng) {
            //*********************************
            var pos = new google.maps.LatLng(latlng.coords.latitude, latlng.coords.longitude);
            //*********************************
            var circle = new google.maps.Circle({
                fillColor: 'blue',
                fillOpacity: 0.10,
                strokeColor: 'blue',
                strokeOpacity: 0.25,
                strokeWeight: 1,
                map: map
            });
            //*********************************
            var marker = new google.maps.Marker({
                position: pos,
                map: map,
                title: "User location",
                icon: new google.maps.MarkerImage(
                'images/mobileimgs2.png',
                new google.maps.Size(22, 22),
                new google.maps.Point(0, 18),
                new google.maps.Point(11, 11)),
                shadow: null,
                zIndex: 999
            });
            //*********************************
            //map.setCenter(pos);
            marker.setPosition(pos);
            circle.setCenter(pos);
            circle.setRadius(latlng.coords.accuracy);
            map.fitBounds(circle.getBounds());
            //*********************************
            var myLocationControlDiv = document.createElement('DIV');
            var controlUI = document.createElement('DIV');
            controlUI.style.backgroundColor = 'White';
            controlUI.style.margin = '0% -20 0 0%';
            controlUI.style.cursor = 'pointer';
            controlUI.title = 'Click to finalize this route';
            controlUI.innerHTML = '<img src="images/exit.png" />';
            myLocationControlDiv.appendChild(controlUI);
            controlUI.addEventListener('click', function () {
                //alert('This route has been completed.');
                navigator.notification.confirm('Do you want to finalized tracking ? ',
                   function(buttonIndex){
                       if (buttonIndex == 1){
                           //************************************************
                           updateStatus('Arrived');
                           //************************************************
                           //navigator.app.close();
                           //************************************************
                       }
                   },
                   'Tracking',
                   'Yes,Cancel');
            });
            //*********************************
            map.controls[google.maps.ControlPosition.RIGHT_TOP].push(controlUI);
            //*********************************
            updateStatus('Departed');
            //************************************************
            setTimeout(updateStatus,120000,'In-Transit');
            //************************************************
        }
        //***************************************
        </script>
</head>
<body>
    <div data-role="page" id="map-track">
        <div data-role="header" data-position="fixed" style="background-color:#0065B3;color:white;font-size:11px;font-weight:normal;vertical-align:super;">
            <h1 id="span1"></h1>
        </div>
<!--        <div id="floating-panel">-->
            <div id="loader" style="display:none;">
                <div id="center">
                    <img src="images/ajax-loader.gif" />
                </div>
            </div>
<!--        </div>-->
        <div role="main" class="ui-content" id="map-canvas">
            <!-- map loads here... -->
        </div>
         <div id="right-panel"></div>
        <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
            ©BCP Insight Risk Technologies,LLC <span class="jqm-version"></span>
        </div>
        <script type="text/javascript">
            app.initialize();
    </script>
    </div>
    <input type="hidden" id="hdnIdRoute" />
    <input type="hidden" id="hdnUsername" />
    <input type="hidden" id="hdnPassword" />
</body>
</html>