<!DOCTYPE html>
<html>
<head>
    <title> </title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <!--<script type="text/javascript" src="cordova.js"></script>-->
    <!--<script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/PushNotification.js"></script>-->
    <script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtTcw1C9SfDbgy2aKfOt_5N8m2Ltpqdu8"></script>
    <link type="text/css" href="css/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <link type="text/css" href="css/index.css" rel="stylesheet" />
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
    </style>
    <script type="text/javascript">
		var marker;
		var infoWindow;
		var registrandoPosicion = false,
        idRegistroPosicion,
        ultimaPosicionUsuario,
        marcadorUsuario,
        circle

		google.maps.event.addDomListener(window, 'load', initialize);

		function initialize() {
		    //*********************************
		    var IdAlert = getUrlVars()["IdAlert"];
		    var IdSite = getUrlVars()["IdSite"];
		    var IdCompany = getUrlVars()["IdCompany"];
		    var IdHazard = getUrlVars()["IdHazard"];
		    var IdContact = getUrlVars()["IdContact"];
		    ////*********************************
		    $("#hdnIdCompany").val(IdCompany);
		    $("#hdnIdAlert").val(IdAlert);
		    $("#hdnIdSite").val(IdSite);
		    $("#hdnIdContact").val(IdContact);
		    $("#hdnIdHazard").val(IdHazard);
		    //alert(IdAlert + ' ' + IdSite + ' ' + IdCompany + ' ' + IdHazard + ' ' + IdContact)
		    //*********************************
		    if (navigator.geolocation) {
		        var timeoutVal = 10 * 1000 * 1000;
		        navigator.geolocation.watchPosition(
                    displayPosition,
                    displayError,
                    { enableHighAccuracy: true, timeout: timeoutVal, maximumAge: 0, frequency: 20000 }
                );
		    }
		    else {
		        alert("Geolocation is not supported by this browser");
		    }
		    //*********************************
		}
		function displayPosition(position) {
		    //************************************************
		    var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
		    //************************************************
			var options = {
				zoom: 16,
				center: pos,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
		    //************************************************
			var map = new google.maps.Map(document.getElementById("map"), options);
		    //************************************************
			circle = new google.maps.Circle({
			    fillColor: 'blue',
			    fillOpacity: 0.10,
			    strokeColor: 'blue',
			    strokeOpacity: 0.25,
			    strokeWeight: 1,
			    map: map
			});
		    //************************************************
		    // Remove the current marker, if there is one
			if (typeof (marker) != "undefined") marker.setMap(null);
		    //************************************************
			marker = new google.maps.Marker({
				position: pos,
				map: map,
				title: "User location",
				icon: new google.maps.MarkerImage(
                             'images/mobileimgs2.png',
                             new google.maps.Size(22, 22),
                             new google.maps.Point(0, 18),
                             new google.maps.Point(11, 11)),
				shadow: null,
				zIndex: 999
			});
		    //************************************************
			var contentString = "<b>Timestamp:</b> " + parseTimestamp(position.timestamp) + "<br/><b>User location:</b> lat " + position.coords.latitude + ", long " + position.coords.longitude + ", accuracy " + position.coords.accuracy;
		    //************************************************
			// Remove the current infoWindow, if there is one
			if (typeof (infoWindow) != "undefined") infoWindow.setMap(null);
		    //************************************************
			infowindow = new google.maps.InfoWindow({
				content: contentString
			});
		    //************************************************
			infowindow.open(map, marker);
		    //************************************************
			map.setCenter(pos);
			marker.setPosition(pos);
			circle.setCenter(pos);
			circle.setRadius(position.coords.accuracy);
			map.fitBounds(circle.getBounds());
		    //************************************************
			google.maps.event.addListener(marker, 'click', function() {
				infowindow.open(map,marker);
		    });
		    //************************************************
			var IdCompany = $("#hdnIdCompany").val();
			var IdAlert = $("#hdnIdAlert").val();
			var IdSite = $("#hdnIdSite").val();
			var IdContact = $("#hdnIdContact").val();
			var IdHazard = $("#hdnIdHazard").val();
		    //************************************************
			var wcfServiceUrl = "https://services.chancesrmis.com/wcfphonegap/InsightBCPWDSL.svc/";
		    //************************************************
			var urlk1 = wcfServiceUrl + "SaveHistoryLocationUser?IdAlert=" + IdAlert + '&IdCompany=' + IdCompany + '&IdContact=' + IdContact + '&IdLocation=' + IdSite + '&IdHazard=' + IdHazard + '&Latitude=' + position.coords.latitude + '&Longitude=' + position.coords.longitude;
		    //************************************************
			$.ajax({
			    //cache: true,
			    async: true,
			    url: urlk1,
			    crossDomain: true,
			    data: "{ IdAlert: " + IdAlert + ", IdCompany: " + IdCompany + ", IdContact: " + IdContact + ", IdLocation:" + IdSite + ", Latitude: '" + position.coords.latitude + "', Longitude: '" + position.coords.longitude + "' }",
			    type: "GET",
			    jsonpCallback: "HistoryUser",
			    contentType: "application/json; charset=utf-8",
			    dataType: "jsonp",
			    beforeSend: function () {
			        //$('#loader').show();
			    },
			    error: function (xhr, textStatus, err) {
			        var mensaje = "readyState: " + xhr.readyState + "\n";
			        mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
			        mensaje = mensaje + "status: " + xhr.status + "\n";
			        mensaje = mensaje + "text status: " + textStatus + "\n";
			        mensaje = mensaje + "error: " + err + "\n";
			        //navigator.notification.alert(mensaje, function () { }, "BCP Error");
			        //$('#loader').hide();
			    },
			    success: function (objHistory) {
			        //******************************
			        if (objHistory.SaveHistoryLocationUserResult > 0) {
			            //navigator.notification.alert('Sucessful saved.');
			        }
			        //******************************
			    },
			    complete: function () {
			        //$('#loader').hide();
			    }
			});
		    //***************************************
			//var posicionActual = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
			//navigator.notification.alert(google.maps.geometry.spherical.computeDistanceBetween(posicionActual, pos), function () { }, "BCP Error");
		    //***************************************
		}
		function displayError(error) {
			var errors = {
				1: 'Permission denied',
				2: 'Position unavailable',
				3: 'Request timeout'
			};
			alert("Error: " + errors[error.code]);
		}
		function parseTimestamp(timestamp) {
			var d = new Date(timestamp);
			var day = d.getDate();
			var month = d.getMonth() + 1;
			var year = d.getFullYear();
			var hour = d.getHours();
			var mins = d.getMinutes();
			var secs = d.getSeconds();
			var msec = d.getMilliseconds();
			return day + "." + month + "." + year + " " + hour + ":" + mins + ":" + secs + "," + msec;
		}
    </script>
</head>
<body>
    <div id="map"></div>
    <div class="jqm-footer" data-role="footer" data-position="fixed" data-tap-toggle="false" style="background-color:#0065B3;color:white;text-align:center;font-size:11px;font-weight:normal;">
        ©BCP Insight Risk Technologies,LLC <span class="jqm-version"></span>
    </div>
    <!--<script type="text/javascript">
            app.initialize();
    </script>-->
    <input type="hidden" id="hdnIdCompany" />
    <input type="hidden" id="hdnIdAlert" />
    <input type="hidden" id="hdnIdSite" />
    <input type="hidden" id="hdnIdContact" />
    <input type="hidden" id="hdnIdHazard" />
</body>
</html>