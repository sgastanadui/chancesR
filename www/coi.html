<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <link rel="stylesheet" type="text/css" href="jquery/jquery.mobile-1.4.5.css" />
    <link rel="stylesheet" type="text/css" href="css/set1.css" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Certificate Of Insurance</title>
    <style type="text/css">
        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            -webkit-border-radius: 5px;
            border-radius: 5px;
            display: inline-block;
            padding: 0 20px;
            margin-bottom: 20px;
            cursor: pointer;
            width: 90%;
            background: #0065B3;
            background: -webkit-gradient(linear, 0 0, 0 70%, from(#0065B3), to(#0065B3));
            background: linear-gradient(#0065B3, #0065B3 70%);
            border: 1px solid #C97917;
            font-size: 0.8em;
            font-weight: 200;
            font-family: Tahoma, Arial, Helvetica;
            font-weight: bold;
            color: #FFFFFF;
            text-shadow: 0 -1px 0 #0065B3;
            height: 40px;
            line-height: 40px;
            text-align: center;
        }

            .custom-file-upload:hover {
                background-color: #0065B3;
                color: #FFFFFF;
            }

        .button {
            -webkit-border-radius: 5px;
            border-radius: 5px;
            display: inline-block;
            padding: 0 20px;
            margin-bottom: 20px;
            cursor: pointer;
            width: 90%;
            background: #0065B3;
            background: -webkit-gradient(linear, 0 0, 0 70%, from(#0065B3), to(#0065B3));
            background: linear-gradient(#0065B3, #0065B3 70%);
            border: 1px solid #C97917;
            font-size: 0.8em;
            font-weight: 200;
            font-family: Tahoma, Arial, Helvetica;
            font-weight: bold;
            color: #FFFFFF;
            text-shadow: 0 -1px 0 #0065B3;
            height: 40px;
            line-height: 40px;
            text-align: center;
        }

            .button span {
                cursor: pointer;
                display: inline-block;
                position: relative;
                transition: 0.5s;
            }

                .button span:after {
                    content: '\00bb';
                    position: absolute;
                    opacity: 0;
                    top: 0;
                    right: -20px;
                    transition: 0.5s;
                }

            .button:hover span {
                padding-right: 25px;
            }

                .button:hover span:after {
                    opacity: 1;
                    right: 0;
                }
    </style>
</head>
<body>
    <div data-role="page">
        <!-- /header-->
        <div data-role="header" data-position="fixed" style="background-color:#0065B3;color:white; text-align:right">
            <!--                <h1 id="span1"><a href="home.html" style="color:white; text-decoration:none">Regresar</a></h1>-->
            <a href="javascript:history.back(1);" data-role="button" data-icon="arrow-l" data-iconpos="notext" data-theme="b" data-iconshadow="false" data-inline="true"></a>
        </div>
        <!-- /BODY-->
        <div data-role="tabs" data-position="fixed" data-tap-toggle="false" style="width:100%">
            <div data-role="navbar" class="ui-navbar" data-position="fixed" data-tap-toggle="false" role="navigation">
                <ul>
                    <li><a href="#fragment-1" class="ui-btn-active">View COI</a></li>
                    <li><a href="#fragment-2">Upload COI</a></li>
                </ul>
            </div>
            <div id="fragment-1" class="ui-body-d ui-content" style="align-content:center" data-role="content">
                <div id="divViewContract">
                    <iframe id="FramePDFCOI" src="" scrolling="auto" frameborder="0" hspace="0" vspace="0" type="application/pdf" width="100%" style="position:relative;-webkit-overflow-scrolling: touch !important;overflow-y: scroll !important;"></iframe>
                </div>
            </div>
            <div id="fragment-2" class="ui-body-d ui-content" style="align-content:center" data-role="content">
                <table align="center">
                    <tr>
                        <td>
                            <label id="lblFile" class="custom-file-upload">
                                <input type="file" id="imageFile" name="imageFile" multiple="multiple" />Select File
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
                </table>
                <div id="grFoto"></div>
                <div id="grfile"></div>
                <input type="button" class="btn-block" value="Save" id="btnGuardar" onclick="uploadPics();">
                <input type="button" class="btn-block" value="Cancel" id="btnRegresar">
            </div>
        </div>
    </div>
    <div id="loader" style="display:none;">
        <div id="center">
            <img src="images/ajax-loader.gif" />
        </div>
    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/platformOverrides.js"></script>
    <script type="text/javascript" src="scripts/index.js"></script>
    <script type="text/javascript" src="scripts/PushNotification.js"></script>
    <script type="text/javascript" src="jquery/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="jquery/jquery.mobile-1.4.5.js"></script>
    <script type="text/javascript" src="scripts/encodedecode.js"></script>
    <script type="text/javascript" src="scripts/common.js"></script>
    <script>
        var images = [];
        var nombres = [];

        $(document).ready(function () {
            var Code = window.localStorage["Code"];
            var IdCompany = window.localStorage["IdCompany"];
            var IdVendor = window.localStorage["IdVendor"];
            var IdCertificate = getUrlVars()["idcer"];
            OpenFileCOI(Code, IdCertificate, IdCompany, IdVendor);
            $('#FramePDFCOI').height(getRealContentHeight() - 40);
            $("#btnGuardar").attr("disabled", "disabled");
            var FileIndex = 0;
            $('#imageFile').on('change', function () {
                for (var i = 0; i < $(this).get(0).files.length; ++i) {
                    display($(this).get(0).files[i], "grFoto");
                    var str = $(this).get(0).files[i].name;
                    var name = str.substr(0, str.lastIndexOf(".")).toLowerCase() + FileIndex;
                    var ext = str.substr(str.lastIndexOf('.')).toLowerCase();
                    var nombreCompleto = name + ext;
                    nombres.push(nombreCompleto);
                    FileIndex++;
                }
            });

            $('#btnRegresar').click(function () {
                $('#lblFile').show();
                $('#grFoto').show();
                $('#grFoto').empty();
                $('#grfile').empty();
                images = [];
                nombres = [];
                $("#btnGuardar").attr("disabled", "disabled");
            });
        });

        function display(file, containerid) {
            var ext = file.name.substr(file.name.lastIndexOf('.') + 1).toLowerCase();
            if ((ext == "png" || ext == "jpeg" || ext == "jpg")) {
                if (typeof FileReader != "undefinied") {
                    $('#grfile').hide();
                    var container = document.getElementById(containerid), img = document.createElement("img"), reader;
                    img.setAttribute("width", "33%");
                    container.appendChild(img);
                    reader = new FileReader();
                    reader.onload = (function (theImg) {
                        return function (evt) {
                            theImg.src = evt.target.result;
                            images.push(evt.target.result);
                        };
                    }(img));
                    reader.readAsDataURL(file);
                    $("#btnGuardar").attr("disabled", false);
                }
            }
            else {
                if (ext == "pdf") {
                    $(containerid).hide();
                    $('#btnSave').hide();
                    $('#lblFile').hide();
                    if (typeof FileReader != "undefinied") {
                        $('#grFoto').hide();
                        $('#grfile').show();
                        var container = document.getElementById("grfile"), img = document.createElement("iframe"), reader;
                        img.setAttribute("width", "100%");
                        img.setAttribute("height", "60%");
                        container.appendChild(img);
                        reader = new FileReader();
                        reader.onload = (function (theImg) {
                            return function (evt) {
                                theImg.src = evt.target.result;
                                images.push(evt.target.result);
                            };
                        }(img));
                        reader.readAsDataURL(file);
                        $("#btnGuardar").attr("disabled", false);
                    }
                }
                else {
                    navigator.notification.alert("Can't upload this document.", function () { }, "ChancesR Error");
                }
            }
        }

        function uploadPics() {
            $('#loader').show();
            if (navigator.notification.confirm("Upload this document's?", function (e) {
                var defs = [];
                var ext;
                var cont = 0;
                if (e == 1) {
                    images.forEach(function (i) {
                        ext = nombres[cont].substr(nombres[cont].lastIndexOf('.') + 1).toLowerCase();
                        var def = $.Deferred();

                        function win(r) {
                            console.log("thing done");
                            if ($.trim(r.response) === "0") {
                                console.log("this one failed");
                                def.resolve(0);
                            } else {
                                console.log("this one passed");
                                def.resolve(1);
                            }
                        }

                        function fail(error) {
                            console.log("upload error source " + error.source);
                            console.log("upload error target " + error.target);
                            def.resolve(0);
                        }

                        var uri = encodeURI("https://www.chancesrmis.com/crmg-usa/UploadFiles/UploadChancesRCRMGMobile.aspx?idvendor=" + getUrlVars()["idven"] + "&idjob=" + getUrlVars()["idjob"] + "&idcertificate=" + getUrlVars()["idcer"] + "&idcom=" + getUrlVars()["idcom"] + "");

                        if ((ext == "png" || ext == "jpeg" || ext == "jpg")) {
                            var options = new FileUploadOptions();
                            options.fileKey = "file";
                            options.fileName = nombres[cont];
                            options.mimeType = "image/jpeg";
                        }
                        else {
                            var options = new FileUploadOptions();
                            options.fileKey = "file";
                            options.fileName = nombres[cont];
                            options.mimeType = "application/pdf";
                        }
                        var ft = new FileTransfer();
                        ft.upload(i, uri, win, fail, options);
                        defs.push(def.promise());
                        cont++;
                    });

                    $.when.apply($, defs).then(function () {
                        console.log("all things done");
                        ext = nombres[0].substr(nombres[0].lastIndexOf('.') + 1).toLowerCase();
                        navigator.notification.alert("Document`s uploaded succesfully", function () { }, "ChancesR");
                        if (ext == "pdf") {
                            updateCertificate(nombres[0]);
                        }
                        else {
                            PDFImages();
                        }
                        console.dir(arguments);
                        $('#loader').hide();
                        $("#btnRegresar").click();
                    });
                }
            }, "ChancesR")) {

            }
        };

        function updateCertificate(filename) {
            try {
                //**************************************
                var input =
                    {
                        idvendor: getUrlVars()["idven"],
                        idjob: getUrlVars()["idjob"],
                        idcertificate: getUrlVars()["idcer"],
                        filename: filename
                    };
                //**************************************
                $.ajax({
                    cache: true,
                    url: "https://www.chancesrmis.com/crmg-usa/UploadFiles/UploadChancesRMobile.asmx/UpdateDocument",
                    async: true,
                    crossDomain: true,
                    type: "POST",
                    data: JSON.stringify(input),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Basic " + Base64.encode("jcJizIJh4EH/e4CBrJFW+A==" + ":" + "d6jlUv9AGSgd219JJvPShA=="));
                        xhr.setRequestHeader("X-Mobile", "false");
                        $('#loader').show();
                    },
                    error: function (xhr, textStatus, err) {
                        var mensaje = "readyState: " + xhr.readyState + "\n";
                        mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                        mensaje = mensaje + "status: " + xhr.status + "\n";
                        mensaje = mensaje + "text status: " + textStatus + "\n";
                        mensaje = mensaje + "error: " + err + "\n";
                        $('#loader').hide();
                        navigator.notification.alert(mensaje, function () { }, "ChancesR Error");
                    },
                    success: function (lstObj) {
                        //**************************************
                        navigator.notification.alert("Document`s uploaded succesfully", function () { }, "ChancesR");
                        //**************************************
                    },
                    complete: function () {
                        $('#loader').hide();
                    }
                });
                //***************************************
            } catch (ex) {
                alert(ex.message);
            }
        }

        function PDFImages() {
            try {
                //**************************************
                nombres.push(getUrlVars()["certificatename"]);
                nombres.push(getUrlVars()["idven"]);
                nombres.push(getUrlVars()["idjob"]);
                nombres.push(getUrlVars()["idcer"]);
                nombres.push(getUrlVars()["idcom"]);
                var input =
                    {
                        arrNombres: nombres
                    };
                //**************************************
                $.ajax({
                    //cache: true,
                    url: "https://www.chancesrmis.com/crmg-usa/UploadFiles/UploadChancesRMobile.asmx/images",
                    async: true,
                    //crossDomain: true,
                    type: "POST",
                    data: JSON.stringify(input),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Basic " + Base64.encode("jcJizIJh4EH/e4CBrJFW+A==" + ":" + "d6jlUv9AGSgd219JJvPShA=="));
                        xhr.setRequestHeader("X-Mobile", "false");
                        $('#loader').show();
                    },
                    error: function (xhr, textStatus, err) {
                        var mensaje = "readyState: " + xhr.readyState + "\n";
                        mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                        mensaje = mensaje + "status: " + xhr.status + "\n";
                        mensaje = mensaje + "text status: " + textStatus + "\n";
                        mensaje = mensaje + "error: " + err + "\n";
                        $('#loader').hide();
                        navigator.notification.alert(mensaje, function () { }, "ChancesR Error");
                    },
                    success: function (lstObj) {
                        //**************************************
                        navigator.notification.alert("Update Certificate.", function () { }, "ChancesR");
                        //**************************************
                    },
                    complete: function () {
                        $('#loader').hide();
                    }
                });
                //***************************************
            } catch (ex) {
                alert(ex.message);
            }
        }

        function OpenFileCOI(Code, IdCertificate, IdCompany, IdVendor) {
            try {
                //**************************************
                var input =
                    {
                        Code: Code,
                        IdCertificate: IdCertificate,
                        IdCompany: IdCompany,
                        IdVendor: IdVendor
                    };
                //**************************************
                $.ajax({
                    cache: true,
                    url: "https://services.chancesrmis.com/ServicesMobile/wcfchancesR/CertificateOfInsurance.svc/DocumentCertificate",
                    async: true,
                    crossDomain: true,
                    type: "POST",
                    data: JSON.stringify(input),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Basic " + Base64.encode("jcJizIJh4EH/e4CBrJFW+A==" + ":" + "d6jlUv9AGSgd219JJvPShA=="));
                        xhr.setRequestHeader("X-Mobile", "false");
                        $('#loader').show();
                    },
                    error: function (xhr, textStatus, err) {
                        var mensaje = "readyState: " + xhr.readyState + "\n";
                        mensaje = mensaje + "responseText: " + xhr.responseText + "\n";
                        mensaje = mensaje + "status: " + xhr.status + "\n";
                        mensaje = mensaje + "text status: " + textStatus + "\n";
                        mensaje = mensaje + "error: " + err + "\n";
                        $('#loader').hide();
                        navigator.notification.alert(mensaje, function () { }, "ChancesR Error");
                    },
                    success: function (lstObj) {
                        //**************************************
                        $('#FramePDFCOI').attr('src', lstObj.DocumentCertificateResult + '#zoom=100');
                        //**************************************
                    },
                    complete: function () {
                        $('#loader').hide();
                    }
                });
                //***************************************
            } catch (ex) {
                alert(ex.message);
            }
        }

    </script>

</body>
</html>